
name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  PNPM_VERSION: '8.15.0'

jobs:
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint
        continue-on-error: false

      - name: Run Prettier Check
        run: pnpm run format:check
        continue-on-error: false

      - name: TypeScript Type Check
        run: pnpm run type-check
        continue-on-error: false

      - name: Check for Circular Dependencies
        run: pnpm run check:circular
        continue-on-error: true

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Unit Tests - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run test:unit
        env:
          NODE_ENV: test

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          files: ./services/${{ matrix.service }}/coverage/coverage-final.json
          flags: unit-${{ matrix.service }}
          name: unit-tests-${{ matrix.service }}
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: app_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: app_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        service:
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:generate

      - name: Run Database Migrations - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:migrate:deploy
        env:
          DATABASE_URL: postgresql://app_test:test_password@localhost:5432/app_test_db

      - name: Run Integration Tests - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run test:integration
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://app_test:test_password@localhost:5432/app_test_db
          REDIS_URL: redis://localhost:6379

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        with:
          files: ./services/${{ matrix.service }}/coverage/coverage-final.json
          flags: integration-${{ matrix.service }}
          name: integration-tests-${{ matrix.service }}
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: app_e2e
          POSTGRES_PASSWORD: e2e_password
          POSTGRES_DB: app_e2e_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Clients
        run: pnpm run prisma:generate:all

      - name: Run Database Migrations
        run: pnpm run prisma:migrate:all
        env:
          DATABASE_URL: postgresql://app_e2e:e2e_password@localhost:5432/app_e2e_db

      - name: Seed Test Data
        run: pnpm run seed:all
        env:
          DATABASE_URL: postgresql://app_e2e:e2e_password@localhost:5432/app_e2e_db

      - name: Run E2E Tests
        run: pnpm run test:e2e
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://app_e2e:e2e_password@localhost:5432/app_e2e_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_key_for_e2e
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-results
          path: tests/e2e/reports/
          retention-days: 7

  build:
    name: Build All Services
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [code-quality, unit-tests]

    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run build

      - name: Check Build Artifacts
        run: |
          if [ ! -d "services/${{ matrix.service }}/dist" ]; then
            echo "Build failed - dist directory not found"
            exit 1
          fi

  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build]

    strategy:
      matrix:
        service:
          - api-gateway
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image - ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/${{ matrix.service }}/Dockerfile
          push: false
          tags: my-app/${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  coverage:
    name: Code Coverage Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: false

      - name: Generate Coverage Badge
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate

  prisma-validation:
    name: Prisma Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        service:
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Prisma Schema - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:validate

      - name: Check Prisma Format - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:format --check

  migration-tests:
    name: Database Migration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: app_migration_test
          POSTGRES_PASSWORD: migration_test_password
          POSTGRES_DB: app_migration_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      matrix:
        service:
          - auth-service
          - product-service
          - order-payment-service
          - appointment-service
          - content-service
          - customer-service
          - notification-service
          - analytics-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Migrations - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:migrate:deploy
        env:
          DATABASE_URL: postgresql://app_migration_test:migration_test_password@localhost:5432/app_migration_test_db

      - name: Validate Migration Status - ${{ matrix.service }}
        run: pnpm --filter ${{ matrix.service }} run prisma:migrate:status
        env:
          DATABASE_URL: postgresql://app_migration_test:migration_test_password@localhost:5432/app_migration_test_db

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: app_contract_test
          POSTGRES_PASSWORD: contract_test_password
          POSTGRES_DB: app_contract_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API Contract Tests
        run: pnpm run test:contract
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://app_contract_test:contract_test_password@localhost:5432/app_contract_test_db
          REDIS_URL: redis://localhost:6379

  performance-tests:
    name: Performance & Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'performance')

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: app_perf_test
          POSTGRES_PASSWORD: perf_test_password
          POSTGRES_DB: app_perf_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Start Services
        run: pnpm run start:all &
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://app_perf_test:perf_test_password@localhost:5432/app_perf_test_db
          REDIS_URL: redis://localhost:6379

      - name: Wait for Services to Start
        run: sleep 30

      - name: Install K6 Load Testing Tool
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring \
            --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" \
            | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run Load Tests
        run: pnpm run test:load

      - name: Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-results
          path: tools/load-testing/reports/
          retention-days: 7

  coverage-check:
    name: Code Coverage Check
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Coverage Reports
        uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: true
          verbose: true

      - name: Check Coverage Thresholds
        run: |
          echo "Checking coverage thresholds..."
          

  lighthouse-ci:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API Gateway
        run: pnpm --filter api-gateway run build

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/health
          uploadArtifacts: true
          temporaryPublicStorage: true

  openapi-validation:
    name: OpenAPI Specification Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate OpenAPI Specs
        uses: char0n/swagger-editor-validate@v1
        with:
          definition-file: docs/api/openapi.yaml

      - name: Check for Breaking API Changes
        run: |
          echo "Checking for API breaking changes..."
          

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Check Licenses
        run: |
          npx license-checker --production \
            --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" \
            --summary

  commit-lint:
    name: Commit Message Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Commit Lint
        run: npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Validate Commit Messages
        run: |
          npx commitlint \
            --from ${{ github.event.pull_request.base.sha }} \
            --to ${{ github.event.pull_request.head.sha }} \
            --verbose

  bundle-size-check:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build All Services
        run: pnpm run build:all

      - name: Analyze Bundle Size
        run: |
          echo "Analyzing bundle sizes..."
          find . -name "dist" -type d -exec du -sh {} \;

  dead-code-check:
    name: Dead Code Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Dead Code Detector
        run: npm install -g ts-prune

      - name: Detect Unused Exports
        run: |
          echo "Detecting unused exports..."
          find services -name "tsconfig.json" -execdir ts-prune \; || true

  env-validation:
    name: Environment Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check .env.example Files
        run: |
          echo "Validating .env.example files..."
          find . -name ".env.example" -type f | while read -r file; do
            echo "Checking $file"
            if [ ! -s "$file" ]; then
              echo "Error: $file is empty"
              exit 1
            fi
          done

      - name: Validate Environment Variables
        run: |
          echo "Ensuring all required env vars are documented..."
          

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [ci-success]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs:
      - code-quality
      - security-scan
      - unit-tests
      - integration-tests
      - e2e-tests
      - build
      - docker-build
      - prisma-validation
      - migration-tests
      - api-contract-tests
      - openapi-validation
      - license-check
      - commit-lint
      - env-validation
    if: always()

    steps:
      - name: Check All Jobs Passed
        run: |
          if [[ "${{ needs.code-quality.result }}"       != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}"         != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}"  != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}"          != "success" ]] || \
             [[ "${{ needs.build.result }}"              != "success" ]] || \
             [[ "${{ needs.docker-build.result }}"       != "success" ]] || \
             [[ "${{ needs.prisma-validation.result }}"  != "success" ]] || \
             [[ "${{ needs.migration-tests.result }}"    != "success" ]] || \
             [[ "${{ needs.api-contract-tests.result }}" != "success" ]] || \
             [[ "${{ needs.openapi-validation.result }}" != "success" ]] || \
             [[ "${{ needs.license-check.result }}"      != "success" ]] || \
             [[ "${{ needs.env-validation.result }}"     != "success" ]]; then
            echo "One or more critical jobs failed"
            exit 1
          fi
          echo "All CI checks passed successfully!"

      - name: Generate CI Summary Report
        if: always()
        run: |
          echo "
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality         | ${{ needs.code-quality.result }}       |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan        | ${{ needs.security-scan.result }}      |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests           | ${{ needs.unit-tests.result }}         |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests    | ${{ needs.integration-tests.result }}  |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests            | ${{ needs.e2e-tests.result }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Build                | ${{ needs.build.result }}              |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build         | ${{ needs.docker-build.result }}       |" >> $GITHUB_STEP_SUMMARY
          echo "| Prisma Validation    | ${{ needs.prisma-validation.result }}  |" >> $GITHUB_STEP_SUMMARY
          echo "| Migration Tests      | ${{ needs.migration-tests.result }}    |" >> $GITHUB_STEP_SUMMARY
          echo "| API Contract Tests   | ${{ needs.api-contract-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Post Success Comment on PR
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                '✅ All CI checks passed! Ready for review.',
                '',
                '**Pipeline Summary:**',
                '- ✅ Code Quality',
                '- ✅ Security Scan',
                '- ✅ Unit Tests',
                '- ✅ Integration Tests',
                '- ✅ E2E Tests',
                '- ✅ Build Validation',
                '- ✅ Docker Build',
                '- ✅ Prisma Validation',
                '- ✅ Migration Tests',
                '- ✅ API Contract Tests'
              ].join('\n')
            })

      - name: Post Failure Comment on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                '❌ CI pipeline failed. Please check the logs and fix the issues.',
                '',
                'Click on the failed job(s) in the Actions tab to see detailed error messages.'
              ].join('\n')
            })