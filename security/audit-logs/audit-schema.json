{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.lomashwood.co.uk/security/audit-log/v1.0.0",
  "title": "LomashWood Audit Log Entry",
  "description": "Schema for all audit log events emitted across the Lomash Wood backend platform.",
  "type": "object",
  "required": [
    "id",
    "version",
    "timestamp",
    "service",
    "environment",
    "actor",
    "action",
    "outcome",
    "request"
  ],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "description": "Globally unique audit log entry identifier. CUID v2 format.",
      "pattern": "^[a-z0-9]{24,}$",
      "examples": ["clxaudt10000000000000000001"]
    },
    "version": {
      "type": "string",
      "description": "Audit log schema version. Follows semantic versioning.",
      "enum": ["1.0.0"],
      "examples": ["1.0.0"]
    },
    "timestamp": {
      "type": "string",
      "description": "ISO 8601 UTC timestamp at which the audited event occurred.",
      "format": "date-time",
      "examples": ["2025-01-15T10:00:00.000Z"]
    },
    "service": {
      "type": "string",
      "description": "Originating microservice identifier.",
      "enum": [
        "api-gateway",
        "auth-service",
        "user-service",
        "product-service",
        "order-service",
        "appointment-service",
        "notification-service",
        "analytics-service",
        "payment-service",
        "admin-service",
        "cms-service",
        "file-service"
      ]
    },
    "environment": {
      "type": "string",
      "description": "Deployment environment in which the event occurred.",
      "enum": ["development", "staging", "production"]
    },
    "traceId": {
      "type": "string",
      "description": "Distributed trace identifier for correlating audit entries across services. W3C Trace Context format.",
      "pattern": "^[0-9a-f]{32}$",
      "examples": ["4bf92f3577b34da6a3ce929d0e0e4736"]
    },
    "spanId": {
      "type": "string",
      "description": "Span identifier within the distributed trace.",
      "pattern": "^[0-9a-f]{16}$",
      "examples": ["00f067aa0ba902b7"]
    },
    "correlationId": {
      "type": "string",
      "description": "Request correlation identifier for end-to-end request tracking.",
      "pattern": "^[0-9a-f-]{36}$",
      "examples": ["550e8400-e29b-41d4-a716-446655440000"]
    },
    "actor": {
      "type": "object",
      "description": "Entity that performed the audited action.",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Category of actor.",
          "enum": ["user", "service", "admin", "system", "anonymous"]
        },
        "id": {
          "type": "string",
          "description": "Unique identifier of the actor. Omitted for anonymous actors.",
          "examples": ["clxuser1000000000000000001"]
        },
        "email": {
          "type": "string",
          "description": "Email address of authenticated user actors.",
          "format": "email",
          "examples": ["john.doe@example.com"]
        },
        "role": {
          "type": "string",
          "description": "Role assigned to the actor at the time of the event.",
          "enum": ["USER", "ADMIN", "SUPER_ADMIN", "SERVICE", "GUEST"]
        },
        "sessionId": {
          "type": "string",
          "description": "Session identifier for user actors.",
          "examples": ["clxsess10000000000000000001"]
        },
        "ip": {
          "type": "string",
          "description": "IP address of the actor. IPv4 or IPv6.",
          "examples": ["81.2.69.142", "2001:db8::1"]
        },
        "userAgent": {
          "type": "string",
          "description": "HTTP User-Agent string of the client.",
          "examples": ["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"]
        },
        "serviceName": {
          "type": "string",
          "description": "Name of the calling service for service-to-service actions.",
          "examples": ["notification-service", "payment-service"]
        }
      }
    },
    "action": {
      "type": "object",
      "description": "Description of the action that was performed.",
      "required": ["category", "type", "description"],
      "additionalProperties": false,
      "properties": {
        "category": {
          "type": "string",
          "description": "High-level action category.",
          "enum": [
            "AUTH",
            "USER_MANAGEMENT",
            "DATA_ACCESS",
            "DATA_MODIFICATION",
            "PAYMENT",
            "ORDER",
            "APPOINTMENT",
            "NOTIFICATION",
            "CONFIGURATION",
            "SECURITY",
            "FILE",
            "ADMIN",
            "COMPLIANCE"
          ]
        },
        "type": {
          "type": "string",
          "description": "Specific action type within the category.",
          "enum": [
            "LOGIN",
            "LOGOUT",
            "LOGIN_FAILED",
            "TOKEN_REFRESH",
            "TOKEN_REVOKED",
            "PASSWORD_CHANGED",
            "PASSWORD_RESET_REQUESTED",
            "PASSWORD_RESET_COMPLETED",
            "MFA_ENABLED",
            "MFA_DISABLED",
            "MFA_CHALLENGE_PASSED",
            "MFA_CHALLENGE_FAILED",
            "SESSION_EXPIRED",
            "SESSION_INVALIDATED",
            "USER_CREATED",
            "USER_UPDATED",
            "USER_DELETED",
            "USER_SUSPENDED",
            "USER_REINSTATED",
            "ROLE_ASSIGNED",
            "ROLE_REVOKED",
            "PERMISSION_GRANTED",
            "PERMISSION_REVOKED",
            "RECORD_VIEWED",
            "RECORD_EXPORTED",
            "BULK_EXPORT",
            "PII_ACCESSED",
            "RECORD_CREATED",
            "RECORD_UPDATED",
            "RECORD_DELETED",
            "RECORD_RESTORED",
            "BULK_UPDATE",
            "BULK_DELETE",
            "STATUS_CHANGED",
            "PAYMENT_INITIATED",
            "PAYMENT_COMPLETED",
            "PAYMENT_FAILED",
            "PAYMENT_REFUNDED",
            "PAYMENT_DISPUTED",
            "ORDER_PLACED",
            "ORDER_UPDATED",
            "ORDER_CANCELLED",
            "ORDER_FULFILLED",
            "APPOINTMENT_BOOKED",
            "APPOINTMENT_RESCHEDULED",
            "APPOINTMENT_CANCELLED",
            "APPOINTMENT_COMPLETED",
            "NOTIFICATION_SENT",
            "NOTIFICATION_CANCELLED",
            "CAMPAIGN_LAUNCHED",
            "CONFIG_CHANGED",
            "SECRET_ROTATED",
            "FEATURE_FLAG_TOGGLED",
            "RATE_LIMIT_HIT",
            "BRUTE_FORCE_DETECTED",
            "SUSPICIOUS_ACTIVITY",
            "IP_BLOCKED",
            "FILE_UPLOADED",
            "FILE_DOWNLOADED",
            "FILE_DELETED",
            "CONSENT_GRANTED",
            "CONSENT_WITHDRAWN",
            "DATA_DELETION_REQUESTED",
            "DATA_DELETION_COMPLETED",
            "SAR_REQUESTED"
          ]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the specific action performed.",
          "minLength": 5,
          "maxLength": 500
        }
      }
    },
    "resource": {
      "type": "object",
      "description": "The resource that was acted upon.",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Resource entity type.",
          "enum": [
            "user",
            "session",
            "order",
            "appointment",
            "product",
            "notification",
            "campaign",
            "template",
            "payment",
            "file",
            "config",
            "role",
            "permission",
            "report",
            "export",
            "webhook",
            "api_key"
          ]
        },
        "id": {
          "type": "string",
          "description": "Unique identifier of the affected resource.",
          "examples": ["clxorder10000000000000000001"]
        },
        "displayName": {
          "type": "string",
          "description": "Human-readable name or label for the resource.",
          "examples": ["Order ORD-2025-001", "John Doe", "Spring Kitchen Campaign"]
        },
        "ownerId": {
          "type": "string",
          "description": "Identifier of the user who owns this resource.",
          "examples": ["clxuser1000000000000000001"]
        }
      }
    },
    "outcome": {
      "type": "object",
      "description": "Result of the audited action.",
      "required": ["status"],
      "additionalProperties": false,
      "properties": {
        "status": {
          "type": "string",
          "description": "Outcome status of the action.",
          "enum": ["SUCCESS", "FAILURE", "PARTIAL", "BLOCKED"]
        },
        "statusCode": {
          "type": "integer",
          "description": "HTTP status code returned by the service.",
          "minimum": 100,
          "maximum": 599,
          "examples": [200, 201, 400, 401, 403, 404, 500]
        },
        "errorCode": {
          "type": "string",
          "description": "Application-level error code on failure.",
          "examples": ["INVALID_CREDENTIALS", "TOKEN_EXPIRED", "PERMISSION_DENIED", "RESOURCE_NOT_FOUND"]
        },
        "errorMessage": {
          "type": "string",
          "description": "Non-sensitive error description on failure.",
          "maxLength": 1000
        },
        "durationMs": {
          "type": "integer",
          "description": "Time in milliseconds from request receipt to response.",
          "minimum": 0,
          "examples": [42, 128, 1243]
        }
      }
    },
    "request": {
      "type": "object",
      "description": "Details of the inbound HTTP request that triggered the event.",
      "required": ["method", "path"],
      "additionalProperties": false,
      "properties": {
        "method": {
          "type": "string",
          "description": "HTTP method.",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS", "HEAD"]
        },
        "path": {
          "type": "string",
          "description": "Request path with path parameters substituted by their names.",
          "examples": ["/api/v1/users/:id", "/api/v1/orders", "/api/v1/auth/login"]
        },
        "query": {
          "type": "object",
          "description": "Sanitised query string parameters. Sensitive values replaced with [REDACTED].",
          "additionalProperties": {
            "type": "string"
          }
        },
        "bodyHash": {
          "type": "string",
          "description": "SHA-256 hash of the request body for integrity verification. Never the raw body.",
          "pattern": "^[a-f0-9]{64}$"
        },
        "contentType": {
          "type": "string",
          "description": "Content-Type header value.",
          "examples": ["application/json", "multipart/form-data"]
        },
        "size": {
          "type": "integer",
          "description": "Content-Length of the request body in bytes.",
          "minimum": 0
        }
      }
    },
    "changes": {
      "type": "object",
      "description": "Before and after state for data modification events. Fields containing PII are masked.",
      "additionalProperties": false,
      "properties": {
        "before": {
          "type": "object",
          "description": "State of the resource immediately before the modification.",
          "additionalProperties": true
        },
        "after": {
          "type": "object",
          "description": "State of the resource immediately after the modification.",
          "additionalProperties": true
        },
        "fields": {
          "type": "array",
          "description": "List of field names that were modified.",
          "items": {
            "type": "string"
          },
          "examples": [["status", "updatedAt"], ["email", "name"]]
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Arbitrary service-specific metadata. Must not contain PII or sensitive values.",
      "additionalProperties": true,
      "examples": [
        { "campaignId": "clxcamp100", "channel": "EMAIL" },
        { "appointmentType": "Kitchen Design", "showroom": "London" }
      ]
    },
    "geo": {
      "type": "object",
      "description": "Geolocation derived from the actor's IP address.",
      "additionalProperties": false,
      "properties": {
        "country": {
          "type": "string",
          "description": "ISO 3166-1 alpha-2 country code.",
          "examples": ["GB", "US", "DE"]
        },
        "region": {
          "type": "string",
          "description": "Region or state name.",
          "examples": ["England", "California"]
        },
        "city": {
          "type": "string",
          "description": "City name.",
          "examples": ["London", "Manchester"]
        }
      }
    },
    "tags": {
      "type": "array",
      "description": "Free-form string tags for cross-cutting classification and search.",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9_:-]{1,64}$"
      },
      "uniqueItems": true,
      "examples": [
        ["pii", "gdpr"],
        ["high-value", "payment"],
        ["security:brute-force"]
      ]
    }
  }
}