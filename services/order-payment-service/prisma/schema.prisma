// This is your Prisma schema file for Order & Payment Service
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}


enum EOrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  READY_FOR_PICKUP
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  FAILED
}

enum EPaymentStatus {
  PENDING
  PROCESSING
  AUTHORIZED
  CAPTURED
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum EPaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  STRIPE
  RAZORPAY
  PAYPAL
  BANK_TRANSFER
  CASH_ON_DELIVERY
  UPI
  WALLET
}

enum ERefundStatus {
  PENDING
  PROCESSING
  APPROVED
  REJECTED
  COMPLETED
  FAILED
}

enum ERefundReason {
  CUSTOMER_REQUEST
  DEFECTIVE_PRODUCT
  WRONG_ITEM
  DAMAGED_SHIPMENT
  NOT_AS_DESCRIBED
  ORDER_CANCELLED
  DUPLICATE_ORDER
  FRAUDULENT
  OTHER
}

enum ETransactionType {
  PAYMENT
  REFUND
  CHARGEBACK
  ADJUSTMENT
  FEE
  PAYOUT
}

enum ETransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

enum ECouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_X_GET_Y
}

enum ECouponStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  EXHAUSTED
}

enum EShippingStatus {
  PENDING
  PROCESSING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  RETURNED
}

enum EShippingMethod {
  STANDARD
  EXPRESS
  OVERNIGHT
  SAME_DAY
  PICKUP
  FREIGHT
}

enum EInvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum ETaxType {
  VAT
  GST
  SALES_TAX
  SERVICE_TAX
  CUSTOMS_DUTY
  EXCISE_DUTY
}

model Order {
  id        String   @id @default(cuid())
  orderNumber String @unique @default(cuid())
  
  // Customer Information
  customerId    String
  customerEmail String
  customerPhone String?
  customerName  String
  
  
  status        EOrderStatus @default(PENDING)
  orderType     String       @default("PRODUCT") 
  
 
  subtotal      Decimal      @db.Decimal(10, 2)
  taxAmount     Decimal      @default(0) @db.Decimal(10, 2)
  shippingCost  Decimal      @default(0) @db.Decimal(10, 2)
  discountAmount Decimal     @default(0) @db.Decimal(10, 2)
  totalAmount   Decimal      @db.Decimal(10, 2)
  currency      String       @default("INR")
  

  billingAddress  Json
  shippingAddress Json?
  
 
  notes         String?      @db.Text
  internalNotes String?      @db.Text
  
  
  metadata      Json?
  tags          String[]
  source        String?     
  ipAddress     String?
  userAgent     String?
  
  
  orderDate     DateTime     @default(now())
  confirmedAt   DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  cancelledAt   DateTime?
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  
 
  items         OrderItem[]
  payments      Payment[]
  invoices      Invoice[]
  refunds       Refund[]
  transactions  Transaction[]
  shipping      Shipping?
  appliedCoupons OrderCoupon[]
  
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([orderDate])
  @@index([createdAt])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  

  productId String
  productName String
  productSku  String?
  variantId   String?
  variantName String?
  

  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  subtotal    Decimal  @db.Decimal(10, 2)
  taxAmount   Decimal  @default(0) @db.Decimal(10, 2)
  discount    Decimal  @default(0) @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  

  productImage String?
  productUrl   String?
  attributes   Json?  
  
  
  metadata    Json?
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id        String   @id @default(cuid())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
 
  paymentNumber String         @unique @default(cuid())
  amount        Decimal        @db.Decimal(10, 2)
  currency      String         @default("INR")
  status        EPaymentStatus @default(PENDING)
  method        EPaymentMethod
  
  
  gatewayProvider String?  
  gatewayPaymentId String? @unique
  gatewayCustomerId String?
  gatewayIntentId String?
  gatewaySessionId String?
  
  
  cardLast4     String?
  cardBrand     String?
  cardExpMonth  Int?
  cardExpYear   Int?
  bankName      String?
  accountLast4  String?
  
  
  transactionId String?  @unique
  authorizationCode String?
  receiptNumber String?
  receiptUrl    String?
  
  
  failureCode   String?
  failureMessage String? @db.Text
  
  
  metadata      Json?
  description   String?  @db.Text
  
 
  authorizedAt  DateTime?
  capturedAt    DateTime?
  failedAt      DateTime?
  refundedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  

  refunds       Refund[]
  transactions  Transaction[]
  
  @@index([orderId])
  @@index([status])
  @@index([method])
  @@index([gatewayPaymentId])
  @@index([createdAt])
  @@map("payments")
}

model Invoice {
  id        String   @id @default(cuid())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  
  invoiceNumber String         @unique
  status        EInvoiceStatus @default(DRAFT)
  
  
  subtotal      Decimal @db.Decimal(10, 2)
  taxAmount     Decimal @db.Decimal(10, 2)
  totalAmount   Decimal @db.Decimal(10, 2)
  paidAmount    Decimal @default(0) @db.Decimal(10, 2)
  dueAmount     Decimal @db.Decimal(10, 2)
  currency      String  @default("INR")
  
  
  billTo        Json
  shipTo        Json?
  
  
  billFrom      Json
  
 
  paymentTerms  String?
  dueDate       DateTime?
  
 
  pdfUrl        String?
  pdfStoragePath String?
  

  notes         String? @db.Text
  metadata      Json?
  
 
  issuedAt      DateTime?
  sentAt        DateTime?
  paidAt        DateTime?
  cancelledAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
  @@index([orderId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Refund {
  id        String   @id @default(cuid())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  paymentId String
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  
  refundNumber  String        @unique @default(cuid())
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("INR")
  status        ERefundStatus @default(PENDING)
  reason        ERefundReason
  reasonDetails String?       @db.Text
  

  gatewayRefundId String? @unique
  gatewayStatus   String?
  
 
  requestedBy   String  
  approvedBy    String?
  processedBy   String?

  metadata      Json?
  internalNotes String? @db.Text
  
 
  requestedAt   DateTime  @default(now())
  approvedAt    DateTime?
  processedAt   DateTime?
  completedAt   DateTime?
  failedAt      DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  

  transactions  Transaction[]
  
  @@index([orderId])
  @@index([paymentId])
  @@index([status])
  @@index([reason])
  @@index([requestedAt])
  @@map("refunds")
}

model Transaction {
  id        String   @id @default(cuid())
  
  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  
  refundId  String?
  refund    Refund?  @relation(fields: [refundId], references: [id], onDelete: SetNull)
  
 
  transactionNumber String             @unique @default(cuid())
  type              ETransactionType
  status            ETransactionStatus @default(PENDING)
  

  amount            Decimal @db.Decimal(10, 2)
  currency          String  @default("INR")
  fee               Decimal @default(0) @db.Decimal(10, 2)
  netAmount         Decimal @db.Decimal(10, 2)
  
  
  gatewayTransactionId String?
  gatewayReference     String?
  

  description   String? @db.Text
  metadata      Json?
  

  processedAt   DateTime?
  completedAt   DateTime?
  failedAt      DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
  @@index([orderId])
  @@index([paymentId])
  @@index([refundId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

model Coupon {
  id        String   @id @default(cuid())
  

  code          String        @unique
  name          String
  description   String?       @db.Text
  type          ECouponType
  status        ECouponStatus @default(ACTIVE)
  
 
  discountValue     Decimal  @db.Decimal(10, 2)
  maxDiscountAmount Decimal? @db.Decimal(10, 2)
  minOrderAmount    Decimal? @db.Decimal(10, 2)
  
 
  maxUsageCount     Int?
  maxUsagePerUser   Int?     @default(1)
  currentUsageCount Int      @default(0)
  
  
  startsAt      DateTime
  expiresAt     DateTime
  
  
  applicableCategories String[]
  applicableProducts   String[]
  excludedCategories   String[]
  excludedProducts     String[]
  
  
  firstOrderOnly    Boolean @default(false)
  minimumQuantity   Int?
  customerSegments  String[]
  
 
  metadata      Json?
  internalNotes String? @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
 
  orderCoupons  OrderCoupon[]
  
  @@index([code])
  @@index([status])
  @@index([startsAt])
  @@index([expiresAt])
  @@map("coupons")
}

model OrderCoupon {
  id        String   @id @default(cuid())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  
 
  discountAmount Decimal @db.Decimal(10, 2)
  
  createdAt DateTime @default(now())
  
  @@unique([orderId, couponId])
  @@index([orderId])
  @@index([couponId])
  @@map("order_coupons")
}

model Tax {
  id        String   @id @default(cuid())
  
  
  name          String
  type          ETaxType
  rate          Decimal  @db.Decimal(5, 2)
  description   String?  @db.Text
  

  country       String?
  state         String?
  city          String?
  zipCode       String?
  
 
  applicableCategories String[]
  applicableProducts   String[]
  

  isActive      Boolean  @default(true)
  

  effectiveFrom DateTime
  effectiveTo   DateTime?
  
  
  metadata      Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  
  @@index([type])
  @@index([country])
  @@index([state])
  @@index([isActive])
  @@map("taxes")
}

model Shipping {
  id        String   @id @default(cuid())
  
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  

  trackingNumber String?         @unique
  carrier        String?
  method         EShippingMethod @default(STANDARD)
  status         EShippingStatus @default(PENDING)
  
  
  shippingAddress Json
  
 
  shippingCost    Decimal @db.Decimal(10, 2)
  
 
  trackingUrl     String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  
 
  weight          Decimal? @db.Decimal(10, 2)
  weightUnit      String?  @default("kg")
  dimensions      Json?   
  packageCount    Int      @default(1)
  
 
  deliveryInstructions String? @db.Text
  internalNotes        String? @db.Text
  
 
  metadata        Json?
  

  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  
  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@map("shipping")
}

model OrderAuditLog {
  id        String   @id @default(cuid())
  
  orderId   String
  
  
  action    String   
  actor     String  
  actorType String  
  
 
  previousData Json?
  newData      Json?
  changes      Json?
  
  
  ipAddress String?
  userAgent String?
  metadata  Json?
  
  createdAt DateTime @default(now())
  
  @@index([orderId])
  @@index([action])
  @@index([createdAt])
  @@map("order_audit_logs")
}
