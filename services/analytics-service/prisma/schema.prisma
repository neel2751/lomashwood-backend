generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native"]
  
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum EventType {
  PAGE_VIEW
  PRODUCT_VIEW
  PRODUCT_FILTER
  PRODUCT_SORT
  ADD_TO_WISHLIST
  REMOVE_FROM_WISHLIST
  SEARCH
  APPOINTMENT_START
  APPOINTMENT_COMPLETE
  APPOINTMENT_ABANDON
  BROCHURE_REQUEST
  BUSINESS_INQUIRY
  CONTACT_FORM
  NEWSLETTER_SIGNUP
  SHOWROOM_VIEW
  BLOG_VIEW
  FINANCE_VIEW
  MEDIA_WALL_VIEW
  CTA_CLICK
  FORM_SUBMIT
  FORM_ABANDON
  SESSION_START
  SESSION_END
  CUSTOM
}

enum DeviceType {
  DESKTOP
  TABLET
  MOBILE
  BOT
  UNKNOWN
}

enum FunnelStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

enum ExportFormat {
  CSV
  JSON
  XLSX
}

enum ReportType {
  TRAFFIC
  CONVERSIONS
  APPOINTMENTS
  PRODUCTS
  FUNNELS
  COHORTS
  CUSTOM
}

enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DashboardType {
  OVERVIEW
  MARKETING
  SALES
  OPERATIONS
  CUSTOM
}

enum MetricAggregation {
  SUM
  AVG
  COUNT
  MIN
  MAX
  UNIQUE
}

enum MetricPeriod {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

// ─── Models ───────────────────────────────────────────────────────────────────

model AnalyticsEvent {
  id          String           @id @default(uuid())
  sessionId   String
  visitorId   String
  userId      String?
  eventType   EventType
  eventName   String
  page        String?
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmContent  String?
  utmTerm     String?
  deviceType  DeviceType       @default(UNKNOWN)
  browser     String?
  os          String?
  country     String?
  region      String?
  city        String?
  ipHash      String?
  properties  Json             @default("{}")
  duration    Int?
  createdAt   DateTime         @default(now())
  session     AnalyticsSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@index([visitorId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@index([page])
  @@index([utmSource, utmMedium, utmCampaign])
  @@map("analytics_events")
}

model AnalyticsSession {
  id          String           @id @default(uuid())
  visitorId   String
  userId      String?
  startedAt   DateTime         @default(now())
  endedAt     DateTime?
  duration    Int?
  pageViews   Int              @default(0)
  deviceType  DeviceType       @default(UNKNOWN)
  browser     String?
  os          String?
  country     String?
  region      String?
  city        String?
  ipHash      String?
  referrer    String?
  landingPage String?
  exitPage    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  bounced     Boolean          @default(false)
  converted   Boolean          @default(false)
  properties  Json             @default("{}")
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  events      AnalyticsEvent[]

  @@index([visitorId])
  @@index([userId])
  @@index([startedAt])
  @@index([country])
  @@index([utmSource, utmMedium, utmCampaign])
  @@map("analytics_sessions")
}

model PageView {
  id          String     @id @default(uuid())
  sessionId   String
  visitorId   String
  userId      String?
  page        String
  title       String?
  referrer    String?
  deviceType  DeviceType @default(UNKNOWN)
  timeOnPage  Int?
  scrollDepth Int?
  country     String?
  createdAt   DateTime   @default(now())

  @@index([sessionId])
  @@index([visitorId])
  @@index([page])
  @@index([createdAt])
  @@map("page_views")
}

model ConversionEvent {
  id             String   @id @default(uuid())
  sessionId      String
  visitorId      String
  userId         String?
  conversionType String
  value          Decimal? @db.Decimal(10, 2)
  currency       String?  @default("GBP")
  productId      String?
  orderId        String?
  appointmentId  String?
  properties     Json     @default("{}")
  createdAt      DateTime @default(now())

  @@index([sessionId])
  @@index([visitorId])
  @@index([conversionType])
  @@index([createdAt])
  @@map("conversion_events")
}

model Funnel {
  id          String         @id @default(uuid())
  name        String
  description String?
  status      FunnelStatus   @default(ACTIVE)
  steps       Json
  createdBy   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  results     FunnelResult[]

  @@index([status])
  @@index([createdAt])
  @@map("funnels")
}

model FunnelResult {
  id               String   @id @default(uuid())
  funnelId         String
  periodStart      DateTime
  periodEnd        DateTime
  stepResults      Json
  totalEntries     Int      @default(0)
  totalCompletions Int      @default(0)
  conversionRate   Decimal  @default(0) @db.Decimal(5, 2)
  computedAt       DateTime @default(now())
  funnel           Funnel   @relation(fields: [funnelId], references: [id])

  @@index([funnelId])
  @@index([periodStart, periodEnd])
  @@map("funnel_results")
}

model Dashboard {
  id          String            @id @default(uuid())
  name        String
  description String?
  type        DashboardType     @default(CUSTOM)
  config      Json
  isDefault   Boolean           @default(false)
  createdBy   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  widgets     DashboardWidget[]

  @@index([type])
  @@index([isDefault])
  @@map("dashboards")
}

model DashboardWidget {
  id          String    @id @default(uuid())
  dashboardId String
  title       String
  widgetType  String
  metricKey   String?
  config      Json      @default("{}")
  position    Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@map("dashboard_widgets")
}

model MetricSnapshot {
  id          String            @id @default(uuid())
  metricKey   String
  period      MetricPeriod
  periodStart DateTime
  periodEnd   DateTime
  value       Decimal           @db.Decimal(20, 4)
  aggregation MetricAggregation @default(SUM)
  dimensions  Json              @default("{}")
  computedAt  DateTime          @default(now())

  @@unique([metricKey, period, periodStart, periodEnd])
  @@index([metricKey])
  @@index([period, periodStart])
  @@map("metric_snapshots")
}

model TrackingConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(true)
  config      Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@map("tracking_configs")
}

model Report {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        ReportType
  status      ReportStatus @default(PENDING)
  parameters  Json         @default("{}")
  result      Json?
  error       String?
  requestedBy String
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  exports     Export[]

  @@index([type])
  @@index([status])
  @@index([requestedBy])
  @@index([createdAt])
  @@map("reports")
}

model Export {
  id          String       @id @default(uuid())
  reportId    String?
  name        String
  format      ExportFormat
  status      ExportStatus @default(PENDING)
  filePath    String?
  fileSize    BigInt?
  rowCount    Int?
  parameters  Json         @default("{}")
  error       String?
  requestedBy String
  expiresAt   DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  report      Report?      @relation(fields: [reportId], references: [id])

  @@index([reportId])
  @@index([status])
  @@index([requestedBy])
  @@index([expiresAt])
  @@map("exports")
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  actorType  String   @default("user")
  action     String
  resource   String
  resourceId String?
  metadata   Json     @default("{}")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

