generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  ORDER
  DELIVERY
  PRODUCT
  APPOINTMENT
  PAYMENT
  REFUND
  GENERAL
  OTHER
}

enum MessageSender {
  CUSTOMER
  AGENT
  SYSTEM
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  EXPIRE
  ADJUST
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum WishlistVisibility {
  PRIVATE
  PUBLIC
}

model Customer {
  id        String    @id @default(dbgenerated("gen_random_uuid()"))
  userId    String    @unique @map("user_id")
  email     String    @unique
  firstName String    @map("first_name")
  lastName  String    @map("last_name")
  phone     String?
  avatarUrl String?   @map("avatar_url")
  isActive  Boolean   @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  profile                 CustomerProfile?
  addresses               CustomerAddress[]
  wishlists               Wishlist[]
  reviews                 Review[]
  supportTickets          SupportTicket[]
  loyaltyAccount          LoyaltyAccount?
  referralsGiven          Referral[]              @relation("ReferrerRelation")
  notificationPreferences NotificationPreference?

  @@index([isActive])
  @@index([deletedAt])
  @@map("customers")
}

model CustomerProfile {
  id                String   @id @default(dbgenerated("gen_random_uuid()"))
  customerId        String   @unique @map("customer_id")
  dateOfBirth       DateTime? @map("date_of_birth") @db.Date
  gender            String?
  bio               String?
  preferredLanguage String   @default("en") @map("preferred_language")
  preferredCurrency String   @default("GBP") @map("preferred_currency")
  marketingOptIn    Boolean  @default(false) @map("marketing_opt_in")
  smsOptIn          Boolean  @default(false) @map("sms_opt_in")
  pushOptIn         Boolean  @default(false) @map("push_opt_in")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_profiles")
}

model CustomerAddress {
  id         String    @id @default(dbgenerated("gen_random_uuid()"))
  customerId String    @map("customer_id")
  label      String    @default("Home")
  line1      String
  line2      String?
  city       String
  county     String?
  postcode   String
  country    String    @default("GB")
  isDefault  Boolean   @default(false) @map("is_default")
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([postcode])
  @@index([deletedAt])
  @@map("customer_addresses")
}

model Wishlist {
  id         String             @id @default(dbgenerated("gen_random_uuid()"))
  customerId String             @map("customer_id")
  name       String             @default("My Wishlist")
  visibility WishlistVisibility @default(PRIVATE)
  deletedAt  DateTime?          @map("deleted_at")
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @updatedAt @map("updated_at")

  customer Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    WishlistItem[]

  @@index([customerId])
  @@index([deletedAt])
  @@map("wishlists")
}

model WishlistItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  wishlistId String   @map("wishlist_id")
  productId  String   @map("product_id")
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")

  wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_items")
}

model Review {
  id         String       @id @default(dbgenerated("gen_random_uuid()"))
  customerId String       @map("customer_id")
  productId  String       @map("product_id")
  orderId    String?      @map("order_id")
  rating     Int
  title      String?
  body       String
  images     String[]     @default([])
  status     ReviewStatus @default(PENDING)
  deletedAt  DateTime?    @map("deleted_at")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId])
  @@index([productId])
  @@index([status])
  @@index([deletedAt])
  @@map("reviews")
}

model SupportTicket {
  id         String          @id @default(dbgenerated("gen_random_uuid()"))
  customerId String          @map("customer_id")
  agentId    String?         @map("agent_id")
  ticketRef  String          @unique @map("ticket_ref")
  subject    String
  category   TicketCategory  @default(GENERAL)
  priority   TicketPriority  @default(MEDIUM)
  status     TicketStatus    @default(OPEN)
  orderId    String?         @map("order_id")
  metadata   Json?
  resolvedAt DateTime?       @map("resolved_at")
  deletedAt  DateTime?       @map("deleted_at")
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")

  customer Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages SupportMessage[]

  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([agentId])
  @@index([deletedAt])
  @@index([createdAt(sort: Desc)])
  @@map("support_tickets")
}

model SupportMessage {
  id          String        @id @default(dbgenerated("gen_random_uuid()"))
  ticketId    String        @map("ticket_id")
  sender      MessageSender
  senderId    String        @map("sender_id")
  body        String
  attachments String[]      @default([])
  isInternal  Boolean       @default(false) @map("is_internal")
  createdAt   DateTime      @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
  @@index([createdAt(sort: Asc)])
  @@map("support_messages")
}

model LoyaltyAccount {
  id              String   @id @default(dbgenerated("gen_random_uuid()"))
  customerId      String   @unique @map("customer_id")
  pointsBalance   Int      @default(0) @map("points_balance")
  pointsEarned    Int      @default(0) @map("points_earned")
  pointsRedeemed  Int      @default(0) @map("points_redeemed")
  tier            String   @default("BRONZE")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer     Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions LoyaltyTransaction[]

  @@map("loyalty_accounts")
}

model LoyaltyTransaction {
  id          String                 @id @default(dbgenerated("gen_random_uuid()"))
  accountId   String                 @map("account_id")
  type        LoyaltyTransactionType
  points      Int
  description String
  reference   String?
  expiresAt   DateTime?              @map("expires_at")
  createdAt   DateTime               @default(now()) @map("created_at")

  account LoyaltyAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([type])
  @@index([expiresAt])
  @@index([createdAt(sort: Desc)])
  @@map("loyalty_transactions")
}

model Referral {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  referrerId     String    @map("referrer_id")
  referredId     String?   @map("referred_id")
  referralCode   String    @unique @map("referral_code")
  status         String    @default("PENDING")
  rewardIssuedAt DateTime? @map("reward_issued_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  referrer Customer @relation("ReferrerRelation", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredId])
  @@index([status])
  @@map("referrals")
}

model NotificationPreference {
  id              String   @id @default(dbgenerated("gen_random_uuid()"))
  customerId      String   @unique @map("customer_id")
  emailOrder      Boolean  @default(true) @map("email_order")
  emailMarketing  Boolean  @default(false) @map("email_marketing")
  emailNewsletter Boolean  @default(false) @map("email_newsletter")
  emailReview     Boolean  @default(true) @map("email_review")
  smsOrder        Boolean  @default(false) @map("sms_order")
  smsMarketing    Boolean  @default(false) @map("sms_marketing")
  pushOrder       Boolean  @default(false) @map("push_order")
  pushMarketing   Boolean  @default(false) @map("push_marketing")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}
