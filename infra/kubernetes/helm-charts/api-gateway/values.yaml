global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

nameOverride: ""
fullnameOverride: ""

image:
  registry: ghcr.io
  repository: lomashwood/api-gateway
  tag: ""
  pullPolicy: IfNotPresent
  pullSecrets: []

replicaCount: 2

podLabels: {}
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"

serviceAccount:
  create: true
  name: ""
  annotations: {}
  automountServiceAccountToken: false

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  fsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 80
  targetPort: 3000
  metricsPort: 9090
  annotations: {}

ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=()";
  hosts:
    - host: api.lomashwood.co.uk
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: api-gateway-tls
      hosts:
        - api.lomashwood.co.uk

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

startupProbe:
  httpGet:
    path: /health
    port: 3000
    scheme: HTTP
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 12
  successThreshold: 1

livenessProbe:
  httpGet:
    path: /health/live
    port: 3000
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: 3000
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  scaleDown:
    stabilizationWindowSeconds: 300
    percentPodPolicy:
      value: 10
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 50
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - api-gateway
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: api-gateway

nodeSelector: {}

tolerations: []

priorityClassName: ""

terminationGracePeriodSeconds: 30

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

volumes:
  - name: tmp
    emptyDir: {}
  - name: cache
    emptyDir: {}

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: cache
    mountPath: /app/.cache

env:
  NODE_ENV: production
  PORT: "3000"
  METRICS_PORT: "9090"
  LOG_LEVEL: info
  LOG_FORMAT: json
  TRUST_PROXY: "1"
  CORS_ORIGIN: "https://www.lomashwood.co.uk,https://admin.lomashwood.co.uk"
  CORS_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
  CORS_MAX_AGE: "86400"
  BODY_LIMIT: 10mb
  REQUEST_TIMEOUT_MS: "30000"
  KEEP_ALIVE_TIMEOUT_MS: "65000"
  HEADERS_TIMEOUT_MS: "70000"
  RATE_LIMIT_WINDOW_MS: "60000"
  RATE_LIMIT_MAX_REQUESTS: "100"
  RATE_LIMIT_SKIP_SUCCESSFUL: "false"
  AUTH_SERVICE_URL: http://auth-service.lomashwood.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood.svc.cluster.local
  PRODUCT_SERVICE_URL: http://product-service.lomashwood.svc.cluster.local
  ORDER_SERVICE_URL: http://order-service.lomashwood.svc.cluster.local
  APPOINTMENT_SERVICE_URL: http://appointment-service.lomashwood.svc.cluster.local
  NOTIFICATION_SERVICE_URL: http://notification-service.lomashwood.svc.cluster.local
  ANALYTICS_SERVICE_URL: http://analytics-service.lomashwood.svc.cluster.local
  PAYMENT_SERVICE_URL: http://payment-service.lomashwood.svc.cluster.local
  CMS_SERVICE_URL: http://cms-service.lomashwood.svc.cluster.local
  FILE_SERVICE_URL: http://file-service.lomashwood.svc.cluster.local
  UPSTREAM_TIMEOUT_MS: "20000"
  UPSTREAM_RETRY_ATTEMPTS: "2"
  UPSTREAM_RETRY_DELAY_MS: "100"
  CIRCUIT_BREAKER_THRESHOLD: "50"
  CIRCUIT_BREAKER_TIMEOUT_MS: "10000"
  CIRCUIT_BREAKER_RESET_MS: "30000"
  JWT_ALGORITHM: RS256
  JWT_AUDIENCE: api.lomashwood.co.uk
  JWT_ISSUER: auth.lomashwood.co.uk
  JWT_CLOCK_TOLERANCE_SECONDS: "10"
  HEALTH_CHECK_DISK_THRESHOLD: "0.9"
  HEALTH_CHECK_MEMORY_THRESHOLD: "0.9"
  REDIS_KEY_PREFIX: "lomash:gw:"
  REDIS_CONNECT_TIMEOUT_MS: "5000"
  REDIS_COMMAND_TIMEOUT_MS: "1000"

envFrom:
  - secretRef:
      name: api-gateway-secrets

secrets:
  create: true
  name: api-gateway-secrets
  data:
    REDIS_URL: ""
    JWT_PUBLIC_KEY: ""
    STRIPE_WEBHOOK_SECRET: ""
    INTERNAL_API_KEY: ""
    SENTRY_DSN: ""

configMap:
  create: true
  name: api-gateway-config
  data: {}

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data
      ports:
        - protocol: TCP
          port: 6379
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: false
  namespace: ""
  interval: 30s
  scrapeTimeout: 10s
  path: /metrics
  labels: {}
  relabelings: []
  metricRelabelings: []

prometheusRule:
  enabled: false
  namespace: ""
  labels: {}
  rules: []

initContainers: []

sidecars: []

extraEnv: []

extraEnvFrom: []

extraVolumes: []

extraVolumeMounts: []

lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 5