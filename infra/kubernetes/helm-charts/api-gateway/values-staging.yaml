replicaCount: 2

image:
  pullPolicy: Always

ingress:
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=()";
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
  hosts:
    - host: api.staging.lomashwood.co.uk
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: api-gateway-staging-tls
      hosts:
        - api.staging.lomashwood.co.uk

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80
  scaleDown:
    stabilizationWindowSeconds: 180
    percentPodPolicy:
      value: 25
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 100
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

terminationGracePeriodSeconds: 30

env:
  NODE_ENV: staging
  LOG_LEVEL: info
  LOG_FORMAT: json
  CORS_ORIGIN: "https://staging.lomashwood.co.uk,https://admin.staging.lomashwood.co.uk"
  RATE_LIMIT_WINDOW_MS: "60000"
  RATE_LIMIT_MAX_REQUESTS: "200"
  RATE_LIMIT_SKIP_SUCCESSFUL: "false"
  BODY_LIMIT: 10mb
  REQUEST_TIMEOUT_MS: "30000"
  AUTH_SERVICE_URL: http://auth-service.lomashwood-staging.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood-staging.svc.cluster.local
  PRODUCT_SERVICE_URL: http://product-service.lomashwood-staging.svc.cluster.local
  ORDER_SERVICE_URL: http://order-service.lomashwood-staging.svc.cluster.local
  APPOINTMENT_SERVICE_URL: http://appointment-service.lomashwood-staging.svc.cluster.local
  NOTIFICATION_SERVICE_URL: http://notification-service.lomashwood-staging.svc.cluster.local
  ANALYTICS_SERVICE_URL: http://analytics-service.lomashwood-staging.svc.cluster.local
  PAYMENT_SERVICE_URL: http://payment-service.lomashwood-staging.svc.cluster.local
  CMS_SERVICE_URL: http://cms-service.lomashwood-staging.svc.cluster.local
  FILE_SERVICE_URL: http://file-service.lomashwood-staging.svc.cluster.local
  UPSTREAM_TIMEOUT_MS: "20000"
  UPSTREAM_RETRY_ATTEMPTS: "2"
  UPSTREAM_RETRY_DELAY_MS: "100"
  CIRCUIT_BREAKER_THRESHOLD: "50"
  CIRCUIT_BREAKER_TIMEOUT_MS: "10000"
  CIRCUIT_BREAKER_RESET_MS: "30000"
  JWT_AUDIENCE: api.staging.lomashwood.co.uk
  JWT_ISSUER: auth.staging.lomashwood.co.uk
  REDIS_KEY_PREFIX: "lomash:gw:staging:"
  HEALTH_CHECK_DISK_THRESHOLD: "0.85"
  HEALTH_CHECK_MEMORY_THRESHOLD: "0.85"

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-staging
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data-staging
      ports:
        - protocol: TCP
          port: 6379
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus

prometheusRule:
  enabled: true
  labels:
    release: prometheus
  rules:
    - alert: ApiGatewayHighErrorRate
      expr: |
        sum(rate(http_requests_total{service="api-gateway",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{service="api-gateway"}[5m])) > 0.05
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: API Gateway error rate above 5%
        description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes."
    - alert: ApiGatewayHighLatency
      expr: |
        histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="api-gateway"}[5m])) by (le)) > 2
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: API Gateway p95 latency above 2s
        description: "p95 latency is {{ $value | humanizeDuration }}."

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - api-gateway
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 50
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - api-gateway
          topologyKey: topology.kubernetes.io/zone