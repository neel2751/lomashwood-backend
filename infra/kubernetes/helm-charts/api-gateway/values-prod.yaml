replicaCount: 4

image:
  pullPolicy: IfNotPresent

ingress:
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "8k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      SecRequestBodyAccess On
      SecAuditEngine RelevantOnly
      SecAuditLogParts ABIJDEFHZ
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: camera=(), microphone=(), geolocation=()";
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.lomashwood.co.uk; frame-ancestors 'none'";
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: api.lomashwood.co.uk
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: api-gateway-prod-tls
      hosts:
        - api.lomashwood.co.uk

resources:
  requests:
    cpu: 200m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

startupProbe:
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 12

livenessProbe:
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

autoscaling:
  enabled: true
  minReplicas: 4
  maxReplicas: 20
  targetCPUUtilizationPercentage: 65
  targetMemoryUtilizationPercentage: 75
  scaleDown:
    stabilizationWindowSeconds: 300
    percentPodPolicy:
      value: 10
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 50
      periodSeconds: 30
    podsPodPolicy:
      value: 4
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 2

terminationGracePeriodSeconds: 60

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 2
    maxUnavailable: 0

priorityClassName: high-priority

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - api-gateway
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - api-gateway
          topologyKey: topology.kubernetes.io/zone

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: api-gateway
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: api-gateway

tolerations:
  - key: dedicated
    operator: Equal
    value: api-tier
    effect: NoSchedule

nodeSelector:
  node-role: api-tier

env:
  NODE_ENV: production
  LOG_LEVEL: warn
  LOG_FORMAT: json
  TRUST_PROXY: "1"
  CORS_ORIGIN: "https://www.lomashwood.co.uk,https://admin.lomashwood.co.uk"
  CORS_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
  CORS_MAX_AGE: "86400"
  BODY_LIMIT: 10mb
  REQUEST_TIMEOUT_MS: "30000"
  KEEP_ALIVE_TIMEOUT_MS: "65000"
  HEADERS_TIMEOUT_MS: "70000"
  RATE_LIMIT_WINDOW_MS: "60000"
  RATE_LIMIT_MAX_REQUESTS: "100"
  RATE_LIMIT_SKIP_SUCCESSFUL: "false"
  AUTH_SERVICE_URL: http://auth-service.lomashwood.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood.svc.cluster.local
  PRODUCT_SERVICE_URL: http://product-service.lomashwood.svc.cluster.local
  ORDER_SERVICE_URL: http://order-service.lomashwood.svc.cluster.local
  APPOINTMENT_SERVICE_URL: http://appointment-service.lomashwood.svc.cluster.local
  NOTIFICATION_SERVICE_URL: http://notification-service.lomashwood.svc.cluster.local
  ANALYTICS_SERVICE_URL: http://analytics-service.lomashwood.svc.cluster.local
  PAYMENT_SERVICE_URL: http://payment-service.lomashwood.svc.cluster.local
  CMS_SERVICE_URL: http://cms-service.lomashwood.svc.cluster.local
  FILE_SERVICE_URL: http://file-service.lomashwood.svc.cluster.local
  UPSTREAM_TIMEOUT_MS: "20000"
  UPSTREAM_RETRY_ATTEMPTS: "2"
  UPSTREAM_RETRY_DELAY_MS: "100"
  CIRCUIT_BREAKER_THRESHOLD: "50"
  CIRCUIT_BREAKER_TIMEOUT_MS: "10000"
  CIRCUIT_BREAKER_RESET_MS: "30000"
  JWT_ALGORITHM: RS256
  JWT_AUDIENCE: api.lomashwood.co.uk
  JWT_ISSUER: auth.lomashwood.co.uk
  JWT_CLOCK_TOLERANCE_SECONDS: "10"
  HEALTH_CHECK_DISK_THRESHOLD: "0.9"
  HEALTH_CHECK_MEMORY_THRESHOLD: "0.9"
  REDIS_KEY_PREFIX: "lomash:gw:"
  REDIS_CONNECT_TIMEOUT_MS: "5000"
  REDIS_COMMAND_TIMEOUT_MS: "500"

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3000
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood
      ports:
        - protocol: TCP
          port: 80
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data
      ports:
        - protocol: TCP
          port: 6379
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: true
  namespace: monitoring
  interval: 15s
  scrapeTimeout: 10s
  labels:
    release: prometheus
  relabelings:
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node
  metricRelabelings:
    - sourceLabels: [__name__]
      regex: go_.*
      action: drop

prometheusRule:
  enabled: true
  namespace: monitoring
  labels:
    release: prometheus
  rules:
    - alert: ApiGatewayHighErrorRate
      expr: |
        sum(rate(http_requests_total{service="api-gateway",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{service="api-gateway"}[5m])) > 0.01
      for: 2m
      labels:
        severity: critical
        environment: production
        team: platform
      annotations:
        summary: API Gateway error rate above 1%
        description: "5xx error rate is {{ $value | humanizePercentage }} over the last 5 minutes. Immediate investigation required."
        runbook: https://runbooks.lomashwood.co.uk/api-gateway/high-error-rate
    - alert: ApiGatewayHighLatency
      expr: |
        histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="api-gateway"}[5m])) by (le)) > 1
      for: 5m
      labels:
        severity: warning
        environment: production
        team: platform
      annotations:
        summary: API Gateway p95 latency above 1s
        description: "p95 latency is {{ $value | humanizeDuration }}."
        runbook: https://runbooks.lomashwood.co.uk/api-gateway/high-latency
    - alert: ApiGatewayHighP99Latency
      expr: |
        histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{service="api-gateway"}[5m])) by (le)) > 3
      for: 5m
      labels:
        severity: critical
        environment: production
        team: platform
      annotations:
        summary: API Gateway p99 latency above 3s
        description: "p99 latency is {{ $value | humanizeDuration }}."
        runbook: https://runbooks.lomashwood.co.uk/api-gateway/high-latency
    - alert: ApiGatewayPodCount
      expr: |
        kube_deployment_status_replicas_available{deployment="api-gateway"} < 3
      for: 1m
      labels:
        severity: critical
        environment: production
        team: platform
      annotations:
        summary: API Gateway available pod count below 3
        description: "Only {{ $value }} pods available. Minimum is 3 for production SLA."
        runbook: https://runbooks.lomashwood.co.uk/api-gateway/pod-count
    - alert: ApiGatewayRateLimitHigh
      expr: |
        sum(rate(rate_limit_hits_total{service="api-gateway"}[5m])) > 50
      for: 10m
      labels:
        severity: warning
        environment: production
        team: platform
      annotations:
        summary: API Gateway sustained rate limiting
        description: "{{ $value | humanize }} rate limit hits per second over the last 10 minutes. Possible abuse or misconfigured client."
    - alert: ApiGatewayCircuitBreakerOpen
      expr: |
        sum(circuit_breaker_state{service="api-gateway",state="open"}) > 0
      for: 1m
      labels:
        severity: critical
        environment: production
        team: platform
      annotations:
        summary: API Gateway circuit breaker is open
        description: "Circuit breaker open for upstream: {{ $labels.upstream }}. Requests are being rejected."
        runbook: https://runbooks.lomashwood.co.uk/api-gateway/circuit-breaker

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"
  cluster-autoscaler.kubernetes.io/safe-to-evict: "true"

podLabels:
  tier: gateway
  criticality: high

lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 10