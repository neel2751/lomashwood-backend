replicaCount: 2

image:
  pullPolicy: Always

resources:
  requests:
    cpu: 150m
    memory: 256Mi
  limits:
    cpu: 750m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 6
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 78
  scaleDown:
    stabilizationWindowSeconds: 180
    percentPodPolicy:
      value: 25
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 100
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - notification-service
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 50
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - notification-service
          topologyKey: topology.kubernetes.io/zone

terminationGracePeriodSeconds: 60

env:
  NODE_ENV: staging
  LOG_LEVEL: info
  LOG_FORMAT: json

  EMAIL_WORKER_CONCURRENCY: "3"
  SMS_WORKER_CONCURRENCY: "5"
  PUSH_WORKER_CONCURRENCY: "10"

  EMAIL_PROVIDER_PRIMARY: nodemailer-smtp
  EMAIL_PROVIDER_FALLBACK: aws-ses
  EMAIL_RATE_LIMIT_PER_MINUTE: "300"
  EMAIL_RETRY_MAX_ATTEMPTS: "4"
  NODEMAILER_MAX_CONNECTIONS: "3"
  SES_REGION: eu-west-2
  SES_MAX_SEND_RATE: "14"

  SMS_PROVIDER_PRIMARY: twilio-sms
  SMS_PROVIDER_FALLBACK: msg91-sms
  SMS_RATE_LIMIT_PER_MINUTE: "60"

  PUSH_RATE_LIMIT_PER_MINUTE: "1000"

  TEMPLATE_CACHE_TTL_SECONDS: "1800"
  TEMPLATE_CACHE_MAX_ITEMS: "250"

  CAMPAIGN_BATCH_SIZE: "500"
  CAMPAIGN_SEND_DELAY_MS: "100"
  CAMPAIGN_MAX_RECIPIENTS: "50000"

  RATE_LIMIT_MAX_REQUESTS: "100"

  DATABASE_POOL_MIN: "2"
  DATABASE_POOL_MAX: "10"

  REDIS_KEY_PREFIX: "lomash:notif:staging:"

  ANALYTICS_SERVICE_URL: http://analytics-service.lomashwood-staging.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood-staging.svc.cluster.local

  HEALTH_CHECK_QUEUE_WAIT_THRESHOLD: "1000"

networkPolicy:
  enabled: true
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: auth-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: order-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: appointment-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3004
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data-staging
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: analytics-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: user-service
      ports:
        - protocol: TCP
          port: 80
    - ports:
        - protocol: TCP
          port: 443
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus

prometheusRule:
  enabled: true
  labels:
    release: prometheus
  rules:
    - alert: NotificationServiceHighFailureRate
      expr: |
        sum(rate(notification_delivery_failures_total{service="notification-service"}[5m]))
        /
        sum(rate(notification_delivery_attempts_total{service="notification-service"}[5m])) > 0.1
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Notification Service delivery failure rate above 10%
        description: "Failure rate is {{ $value | humanizePercentage }} over the last 5 minutes."
    - alert: NotificationServiceQueueDepthHigh
      expr: |
        sum(bullmq_queue_waiting{service="notification-service"}) > 5000
      for: 10m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Notification Service queue depth above 5000
        description: "Queue depth is {{ $value | humanize }} jobs waiting."
    - alert: NotificationServiceHighErrorRate
      expr: |
        sum(rate(http_requests_total{service="notification-service",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{service="notification-service"}[5m])) > 0.05
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Notification Service 5xx error rate above 5%
        description: "Error rate is {{ $value | humanizePercentage }}."

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"