global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

nameOverride: ""
fullnameOverride: ""

image:
  registry: ghcr.io
  repository: lomashwood/notification-service
  tag: ""
  pullPolicy: IfNotPresent
  pullSecrets: []

replicaCount: 2

podLabels: {}
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"

serviceAccount:
  create: true
  name: ""
  annotations: {}
  automountServiceAccountToken: false

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  fsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 80
  targetPort: 3004
  metricsPort: 9090
  annotations: {}

resources:
  requests:
    cpu: 150m
    memory: 256Mi
  limits:
    cpu: 750m
    memory: 1Gi

startupProbe:
  httpGet:
    path: /health
    port: 3004
    scheme: HTTP
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 18
  successThreshold: 1

livenessProbe:
  httpGet:
    path: /health/live
    port: 3004
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 20
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: 3004
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
  scaleDown:
    stabilizationWindowSeconds: 300
    percentPodPolicy:
      value: 10
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 50
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - notification-service
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: notification-service

nodeSelector: {}

tolerations: []

priorityClassName: ""

terminationGracePeriodSeconds: 60

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

volumes:
  - name: tmp
    emptyDir: {}
  - name: templates-cache
    emptyDir: {}

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: templates-cache
    mountPath: /app/.templates-cache

env:
  NODE_ENV: production
  PORT: "3004"
  METRICS_PORT: "9090"
  LOG_LEVEL: info
  LOG_FORMAT: json
  TRUST_PROXY: "1"

  EMAIL_QUEUE_NAME: "lomash:email"
  SMS_QUEUE_NAME: "lomash:sms"
  PUSH_QUEUE_NAME: "lomash:push"
  EMAIL_WORKER_CONCURRENCY: "5"
  SMS_WORKER_CONCURRENCY: "10"
  PUSH_WORKER_CONCURRENCY: "20"
  QUEUE_REMOVE_ON_COMPLETE_AGE: "86400"
  QUEUE_REMOVE_ON_FAIL_COUNT: "1000"
  QUEUE_DEFAULT_JOB_ATTEMPTS: "3"
  QUEUE_STALLED_INTERVAL_MS: "30000"
  QUEUE_MAX_STALLED_COUNT: "2"
  QUEUE_LOCK_DURATION_MS: "30000"

  EMAIL_PROVIDER_PRIMARY: nodemailer-smtp
  EMAIL_PROVIDER_FALLBACK: aws-ses
  EMAIL_FROM_NAME: "Lomash Wood"
  EMAIL_FROM_ADDRESS: noreply@lomashwood.co.uk
  EMAIL_REPLY_TO: hello@lomashwood.co.uk
  EMAIL_TEMPLATE_ENGINE: handlebars
  EMAIL_SUBJECT_MAX_LENGTH: "150"
  EMAIL_ATTACHMENT_MAX_SIZE_MB: "10"
  EMAIL_ATTACHMENT_MAX_COUNT: "5"
  EMAIL_BULK_BATCH_SIZE: "500"
  EMAIL_RATE_LIMIT_PER_MINUTE: "300"
  EMAIL_RETRY_MAX_ATTEMPTS: "4"
  EMAIL_RETRY_INITIAL_DELAY_MS: "5000"
  EMAIL_RETRY_MAX_DELAY_MS: "300000"
  EMAIL_RETRY_MULTIPLIER: "3"
  NODEMAILER_POOL: "true"
  NODEMAILER_MAX_CONNECTIONS: "5"
  NODEMAILER_MAX_MESSAGES: "100"
  SES_REGION: eu-west-2
  SES_MAX_SEND_RATE: "14"

  SMS_PROVIDER_PRIMARY: twilio-sms
  SMS_PROVIDER_FALLBACK: msg91-sms
  SMS_FROM: "+441234567890"
  SMS_BODY_MAX_LENGTH: "1600"
  SMS_SINGLE_SEGMENT_LENGTH: "160"
  SMS_UNICODE_SEGMENT_LENGTH: "70"
  SMS_BULK_BATCH_SIZE: "100"
  SMS_RATE_LIMIT_PER_MINUTE: "60"
  SMS_RETRY_MAX_ATTEMPTS: "3"
  SMS_RETRY_INITIAL_DELAY_MS: "3000"
  SMS_RETRY_MAX_DELAY_MS: "120000"
  SMS_RETRY_MULTIPLIER: "2"

  PUSH_PROVIDER_PRIMARY: firebase-fcm
  PUSH_PROVIDER_FALLBACK: web-push
  PUSH_BULK_BATCH_SIZE: "500"
  PUSH_RATE_LIMIT_PER_MINUTE: "1000"
  PUSH_RETRY_MAX_ATTEMPTS: "3"
  PUSH_RETRY_INITIAL_DELAY_MS: "2000"
  PUSH_RETRY_MAX_DELAY_MS: "60000"
  PUSH_RETRY_MULTIPLIER: "2"
  PUSH_TTL_SECONDS: "86400"
  VAPID_SUBJECT: mailto:push@lomashwood.co.uk

  TEMPLATE_CACHE_TTL_SECONDS: "3600"
  TEMPLATE_CACHE_MAX_ITEMS: "500"
  TEMPLATE_COMPILE_TIMEOUT_MS: "5000"
  TEMPLATE_PREVIEW_MAX_DEPTH: "5"

  CAMPAIGN_BATCH_SIZE: "1000"
  CAMPAIGN_SEND_DELAY_MS: "100"
  CAMPAIGN_MAX_RECIPIENTS: "100000"
  CAMPAIGN_SCHEDULE_CHECK_INTERVAL_MS: "60000"

  WEBHOOK_RETRY_MAX_ATTEMPTS: "5"
  WEBHOOK_RETRY_INITIAL_DELAY_MS: "10000"
  WEBHOOK_TIMEOUT_MS: "10000"
  WEBHOOK_MAX_PAYLOAD_SIZE_KB: "256"

  RATE_LIMIT_WINDOW_MS: "60000"
  RATE_LIMIT_MAX_REQUESTS: "100"

  DATABASE_POOL_MIN: "2"
  DATABASE_POOL_MAX: "10"
  DATABASE_CONNECTION_TIMEOUT_MS: "10000"
  DATABASE_IDLE_TIMEOUT_MS: "30000"
  DATABASE_STATEMENT_TIMEOUT_MS: "30000"

  REDIS_KEY_PREFIX: "lomash:notif:"
  REDIS_CONNECT_TIMEOUT_MS: "5000"
  REDIS_COMMAND_TIMEOUT_MS: "2000"
  REDIS_MAX_RETRIES: "3"

  ANALYTICS_SERVICE_URL: http://analytics-service.lomashwood.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood.svc.cluster.local

  HEALTH_CHECK_DISK_THRESHOLD: "0.9"
  HEALTH_CHECK_MEMORY_THRESHOLD: "0.9"
  HEALTH_CHECK_QUEUE_WAIT_THRESHOLD: "1000"

envFrom:
  - secretRef:
      name: notification-service-secrets

secrets:
  create: true
  name: notification-service-secrets
  data:
    DATABASE_URL: ""
    REDIS_URL: ""
    SMTP_HOST: ""
    SMTP_PORT: ""
    SMTP_USER: ""
    SMTP_PASS: ""
    AWS_ACCESS_KEY_ID: ""
    AWS_SECRET_ACCESS_KEY: ""
    TWILIO_ACCOUNT_SID: ""
    TWILIO_AUTH_TOKEN: ""
    TWILIO_MESSAGING_SERVICE_SID: ""
    MSG91_AUTH_KEY: ""
    MSG91_SENDER_ID: ""
    FIREBASE_SERVICE_ACCOUNT_JSON: ""
    VAPID_PUBLIC_KEY: ""
    VAPID_PRIVATE_KEY: ""
    INTERNAL_API_KEY: ""
    SENTRY_DSN: ""

configMap:
  create: true
  name: notification-service-config
  data: {}

networkPolicy:
  enabled: true
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: auth-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: order-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: appointment-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3004
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: analytics-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: user-service
      ports:
        - protocol: TCP
          port: 80
    - ports:
        - protocol: TCP
          port: 443
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: false
  namespace: ""
  interval: 30s
  scrapeTimeout: 10s
  path: /metrics
  labels: {}
  relabelings: []
  metricRelabelings: []

prometheusRule:
  enabled: false
  namespace: ""
  labels: {}
  rules: []

initContainers: []

sidecars: []

extraEnv: []

extraEnvFrom: []

extraVolumes: []

extraVolumeMounts: []

lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 15