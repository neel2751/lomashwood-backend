global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

nameOverride: ""
fullnameOverride: ""

image:
  registry: ghcr.io
  repository: lomashwood/auth-service
  tag: ""
  pullPolicy: IfNotPresent
  pullSecrets: []

replicaCount: 2

podLabels: {}
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"

serviceAccount:
  create: true
  name: ""
  annotations: {}
  automountServiceAccountToken: false

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  fsGroup: 1001
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 80
  targetPort: 3001
  metricsPort: 9090
  annotations: {}

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

startupProbe:
  httpGet:
    path: /health
    port: 3001
    scheme: HTTP
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 12
  successThreshold: 1

livenessProbe:
  httpGet:
    path: /health/live
    port: 3001
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health/ready
    port: 3001
    scheme: HTTP
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 8
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  scaleDown:
    stabilizationWindowSeconds: 300
    percentPodPolicy:
      value: 10
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 50
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: auth-service

nodeSelector: {}

tolerations: []

priorityClassName: ""

terminationGracePeriodSeconds: 30

updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

volumes:
  - name: tmp
    emptyDir: {}
  - name: keys
    emptyDir:
      medium: Memory

volumeMounts:
  - name: tmp
    mountPath: /tmp
  - name: keys
    mountPath: /app/keys
    readOnly: true

env:
  NODE_ENV: production
  PORT: "3001"
  METRICS_PORT: "9090"
  LOG_LEVEL: info
  LOG_FORMAT: json
  TRUST_PROXY: "1"

  JWT_ALGORITHM: RS256
  JWT_ACCESS_TOKEN_EXPIRY: 15m
  JWT_REFRESH_TOKEN_EXPIRY: 7d
  JWT_AUDIENCE: api.lomashwood.co.uk
  JWT_ISSUER: auth.lomashwood.co.uk
  JWT_CLOCK_TOLERANCE_SECONDS: "10"
  JWT_KEY_PATH: /app/keys

  REFRESH_TOKEN_ROTATION: "true"
  REFRESH_TOKEN_FAMILY_INVALIDATION: "true"
  REFRESH_TOKEN_ABSOLUTE_EXPIRY: 30d
  ACCESS_TOKEN_COOKIE_NAME: lw_at
  REFRESH_TOKEN_COOKIE_NAME: lw_rt
  COOKIE_SECURE: "true"
  COOKIE_SAME_SITE: strict
  COOKIE_DOMAIN: .lomashwood.co.uk
  COOKIE_HTTP_ONLY: "true"

  MFA_TOTP_ISSUER: "Lomash Wood"
  MFA_TOTP_WINDOW: "1"
  MFA_BACKUP_CODE_COUNT: "10"
  MFA_BACKUP_CODE_LENGTH: "8"
  MFA_RATE_LIMIT_ATTEMPTS: "5"
  MFA_RATE_LIMIT_WINDOW_MS: "300000"

  BCRYPT_SALT_ROUNDS: "12"
  PASSWORD_MIN_LENGTH: "12"
  PASSWORD_MAX_LENGTH: "128"
  PASSWORD_REQUIRE_UPPERCASE: "true"
  PASSWORD_REQUIRE_LOWERCASE: "true"
  PASSWORD_REQUIRE_NUMBER: "true"
  PASSWORD_REQUIRE_SYMBOL: "true"
  PASSWORD_BREACHED_CHECK: "true"

  RATE_LIMIT_LOGIN_WINDOW_MS: "900000"
  RATE_LIMIT_LOGIN_MAX: "10"
  RATE_LIMIT_REGISTER_WINDOW_MS: "3600000"
  RATE_LIMIT_REGISTER_MAX: "5"
  RATE_LIMIT_PASSWORD_RESET_WINDOW_MS: "3600000"
  RATE_LIMIT_PASSWORD_RESET_MAX: "3"
  RATE_LIMIT_MFA_WINDOW_MS: "300000"
  RATE_LIMIT_MFA_MAX: "5"

  BRUTE_FORCE_FREE_RETRIES: "3"
  BRUTE_FORCE_MIN_WAIT_MS: "5000"
  BRUTE_FORCE_MAX_WAIT_MS: "900000"
  BRUTE_FORCE_LIFETIME_SECONDS: "86400"

  SESSION_ABSOLUTE_TIMEOUT_MS: "86400000"
  SESSION_IDLE_TIMEOUT_MS: "1800000"
  SESSION_MAX_PER_USER: "5"

  EMAIL_VERIFICATION_EXPIRY_HOURS: "24"
  PASSWORD_RESET_EXPIRY_HOURS: "1"

  CORS_ORIGIN: "https://www.lomashwood.co.uk,https://admin.lomashwood.co.uk"
  CORS_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
  CORS_CREDENTIALS: "true"

  DATABASE_POOL_MIN: "2"
  DATABASE_POOL_MAX: "10"
  DATABASE_CONNECTION_TIMEOUT_MS: "10000"
  DATABASE_IDLE_TIMEOUT_MS: "30000"
  DATABASE_STATEMENT_TIMEOUT_MS: "15000"

  REDIS_KEY_PREFIX: "lomash:auth:"
  REDIS_CONNECT_TIMEOUT_MS: "5000"
  REDIS_COMMAND_TIMEOUT_MS: "1000"
  REDIS_MAX_RETRIES: "3"

  NOTIFICATION_SERVICE_URL: http://notification-service.lomashwood.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood.svc.cluster.local

  HEALTH_CHECK_DISK_THRESHOLD: "0.9"
  HEALTH_CHECK_MEMORY_THRESHOLD: "0.9"

envFrom:
  - secretRef:
      name: auth-service-secrets

secrets:
  create: true
  name: auth-service-secrets
  data:
    DATABASE_URL: ""
    REDIS_URL: ""
    JWT_PRIVATE_KEY: ""
    JWT_PUBLIC_KEY: ""
    SESSION_SECRET: ""
    GOOGLE_CLIENT_ID: ""
    GOOGLE_CLIENT_SECRET: ""
    PWNED_PASSWORDS_API_KEY: ""
    SENTRY_DSN: ""
    INTERNAL_API_KEY: ""

configMap:
  create: true
  name: auth-service-config
  data: {}

networkPolicy:
  enabled: true
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3001
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: notification-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: user-service
      ports:
        - protocol: TCP
          port: 80
    - ports:
        - protocol: TCP
          port: 443
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: false
  namespace: ""
  interval: 30s
  scrapeTimeout: 10s
  path: /metrics
  labels: {}
  relabelings: []
  metricRelabelings: []

prometheusRule:
  enabled: false
  namespace: ""
  labels: {}
  rules: []

initContainers: []

sidecars: []

extraEnv: []

extraEnvFrom: []

extraVolumes: []

extraVolumeMounts: []

lifecycle:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 5