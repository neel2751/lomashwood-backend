replicaCount: 2

image:
  pullPolicy: Always

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80
  scaleDown:
    stabilizationWindowSeconds: 180
    percentPodPolicy:
      value: 25
      periodSeconds: 60
  scaleUp:
    stabilizationWindowSeconds: 60
    percentPodPolicy:
      value: 100
      periodSeconds: 30
    podsPodPolicy:
      value: 2
      periodSeconds: 60

podDisruptionBudget:
  enabled: true
  minAvailable: 1

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - auth-service
        topologyKey: kubernetes.io/hostname
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 50
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - auth-service
          topologyKey: topology.kubernetes.io/zone

terminationGracePeriodSeconds: 30

env:
  NODE_ENV: staging
  LOG_LEVEL: info
  LOG_FORMAT: json

  JWT_ACCESS_TOKEN_EXPIRY: 15m
  JWT_REFRESH_TOKEN_EXPIRY: 7d
  JWT_AUDIENCE: api.staging.lomashwood.co.uk
  JWT_ISSUER: auth.staging.lomashwood.co.uk

  COOKIE_SECURE: "true"
  COOKIE_SAME_SITE: strict
  COOKIE_DOMAIN: .staging.lomashwood.co.uk

  BCRYPT_SALT_ROUNDS: "12"
  PASSWORD_BREACHED_CHECK: "true"

  RATE_LIMIT_LOGIN_MAX: "10"
  RATE_LIMIT_REGISTER_MAX: "5"
  RATE_LIMIT_PASSWORD_RESET_MAX: "3"
  RATE_LIMIT_MFA_MAX: "5"

  BRUTE_FORCE_FREE_RETRIES: "3"
  BRUTE_FORCE_MIN_WAIT_MS: "5000"
  BRUTE_FORCE_MAX_WAIT_MS: "900000"

  SESSION_MAX_PER_USER: "5"

  CORS_ORIGIN: "https://staging.lomashwood.co.uk,https://admin.staging.lomashwood.co.uk"

  DATABASE_POOL_MIN: "2"
  DATABASE_POOL_MAX: "10"

  REDIS_KEY_PREFIX: "lomash:auth:staging:"

  NOTIFICATION_SERVICE_URL: http://notification-service.lomashwood-staging.svc.cluster.local
  USER_SERVICE_URL: http://user-service.lomashwood-staging.svc.cluster.local

networkPolicy:
  enabled: true
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: api-gateway
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: 3001
        - protocol: TCP
          port: 9090
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomashwood-data-staging
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: notification-service
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: user-service
      ports:
        - protocol: TCP
          port: 80
    - ports:
        - protocol: TCP
          port: 443
    - ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus

prometheusRule:
  enabled: true
  labels:
    release: prometheus
  rules:
    - alert: AuthServiceHighLoginFailureRate
      expr: |
        sum(rate(auth_login_failures_total{service="auth-service"}[5m]))
        /
        sum(rate(auth_login_attempts_total{service="auth-service"}[5m])) > 0.3
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Auth Service login failure rate above 30%
        description: "Login failure rate is {{ $value | humanizePercentage }} over the last 5 minutes."
    - alert: AuthServiceHighErrorRate
      expr: |
        sum(rate(http_requests_total{service="auth-service",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{service="auth-service"}[5m])) > 0.05
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Auth Service 5xx error rate above 5%
        description: "Error rate is {{ $value | humanizePercentage }}."
    - alert: AuthServiceHighTokenRefreshLatency
      expr: |
        histogram_quantile(0.95, sum(rate(auth_token_refresh_duration_seconds_bucket{service="auth-service"}[5m])) by (le)) > 0.5
      for: 5m
      labels:
        severity: warning
        environment: staging
      annotations:
        summary: Auth Service token refresh p95 latency above 500ms
        description: "p95 latency is {{ $value | humanizeDuration }}."

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/path: "/metrics"
  prometheus.io/port: "9090"