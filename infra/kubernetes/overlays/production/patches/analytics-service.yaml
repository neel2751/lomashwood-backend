---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics-service
  namespace: lomash-wood-production
  labels:
    app: analytics-service
    env: production
    version: "1.0.0"
    tier: backend
    managed-by: kustomize
  annotations:
    deployment.kubernetes.io/revision: "1"
    meta.helm.sh/release-name: analytics-service
    meta.helm.sh/release-namespace: lomash-wood-production
spec:
  
  
  
  replicas: 3

  selector:
    matchLabels:
      app: analytics-service
      env: production

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app: analytics-service
        env: production
        version: "1.0.0"
      annotations:
        
        checksum/config: "{{ include (print $.Template.BasePath \"/configmap.yaml\") . | sha256sum }}"
        checksum/secret: "{{ include (print $.Template.BasePath \"/secrets.yaml\") . | sha256sum }}"
        
        prometheus.io/scrape: "true"
        prometheus.io/port: "3008"
        prometheus.io/path: "/metrics"
        
        ad.datadoghq.com/analytics-service.logs: >
          [{"source": "nodejs", "service": "analytics-service", "tags": ["env:production"]}]

    spec:
      
      
      
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: analytics-service
              env: production

      
      
      
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - analytics-service
              topologyKey: kubernetes.io/hostname
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role
                    operator: In
                    values:
                      - backend
                  - key: environment
                    operator: In
                    values:
                      - production

      
      
      
      serviceAccountName: analytics-service-sa

      
      
      
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        seccompProfile:
          type: RuntimeDefault

      terminationGracePeriodSeconds: 60

      
      
      
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36-musl
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              until nc -z "$DB_HOST" "$DB_PORT"; do
                echo "Waiting for PostgreSQL at $DB_HOST:$DB_PORT…"
                sleep 3
              done
              echo "PostgreSQL is ready."
          env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: analytics-service-secret
                  key: DB_HOST
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: analytics-service-secret
                  key: DB_PORT
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

        - name: wait-for-redis
          image: busybox:1.36-musl
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              until nc -z "$REDIS_HOST" "$REDIS_PORT"; do
                echo "Waiting for Redis at $REDIS_HOST:$REDIS_PORT…"
                sleep 3
              done
              echo "Redis is ready."
          env:
            - name: REDIS_HOST
              valueFrom:
                secretKeyRef:
                  name: analytics-service-secret
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                secretKeyRef:
                  name: analytics-service-secret
                  key: REDIS_PORT
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

        - name: run-migrations
          image: lomashwood/analytics-service:1.0.0
          imagePullPolicy: Always
          command: ["npx", "prisma", "migrate", "deploy"]
          envFrom:
            - secretRef:
                name: analytics-service-secret
            - configMapRef:
                name: analytics-service-config
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop: ["ALL"]

      
      
      
      containers:
        - name: analytics-service
          image: lomashwood/analytics-service:1.0.0
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 3008
              protocol: TCP
            - name: metrics
              containerPort: 9008
              protocol: TCP

          
          envFrom:
            - configMapRef:
                name: analytics-service-config
            - secretRef:
                name: analytics-service-secret

          env:
            - name: NODE_ENV
              value: "production"
            - name: SERVICE_NAME
              value: "analytics-service"
            - name: PORT
              value: "3008"
            - name: LOG_LEVEL
              value: "info"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName

          
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"

          
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

          
          startupProbe:
            httpGet:
              path: /health/startup
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 12  

          
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

          
          volumeMounts:
            - name: tmp-dir
              mountPath: /tmp
            - name: app-logs
              mountPath: /app/logs

          
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 5"]

      
      
      
      volumes:
        - name: tmp-dir
          emptyDir: {}
        - name: app-logs
          emptyDir: {}

      
      
      
      imagePullSecrets:
        - name: ecr-registry-secret

      
      
      
      dnsConfig:
        options:
          - name: ndots
            value: "2"
          - name: edns0

---

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: analytics-service-hpa
  namespace: lomash-wood-production
  labels:
    app: analytics-service
    env: production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: analytics-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 65
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 120

---

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: analytics-service-pdb
  namespace: lomash-wood-production
  labels:
    app: analytics-service
    env: production
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: analytics-service
      env: production

---



apiVersion: v1
kind: ConfigMap
metadata:
  name: analytics-service-config
  namespace: lomash-wood-production
  labels:
    app: analytics-service
    env: production
data:
  NODE_ENV: "production"
  PORT: "3008"
  SERVICE_NAME: "analytics-service"
  LOG_LEVEL: "info"
  LOG_FORMAT: "json"

  
  DEFAULT_PAGE_SIZE: "20"
  MAX_PAGE_SIZE: "100"

  
  INGESTION_BATCH_SIZE: "500"
  INGESTION_FLUSH_INTERVAL_MS: "5000"
  EVENT_RETENTION_DAYS: "365"
  FUNNEL_RECOMPUTE_INTERVAL_CRON: "0 */6 * * *"
  DASHBOARD_REFRESH_INTERVAL_CRON: "*/15 * * * *"
  PURGE_OLD_EVENTS_CRON: "0 2 * * 0"
  ARCHIVE_HISTORICAL_DATA_CRON: "0 3 1 * *"
  REBUILD_DASHBOARD_CRON: "0 1 * * *"

  
  CACHE_TTL_DASHBOARD: "900"
  CACHE_TTL_FUNNEL: "3600"
  CACHE_TTL_REPORT: "1800"

  
  CORS_ORIGIN: "https://lomashwood.co.uk"
  CORS_CREDENTIALS: "true"

  
  RATE_LIMIT_WINDOW_MS: "60000"
  RATE_LIMIT_MAX_REQUESTS: "200"

  
  OTEL_SERVICE_NAME: "analytics-service"
  OTEL_EXPORTER_OTLP_ENDPOINT: "http://tempo.monitoring.svc.cluster.local:4318"
  OTEL_TRACES_SAMPLER: "parentbased_traceidratio"
  OTEL_TRACES_SAMPLER_ARG: "0.1"

  
  METRICS_PORT: "9008"
  METRICS_PATH: "/metrics"

  
  HEALTH_CHECK_PATH: "/health"
  HEALTH_LIVE_PATH: "/health/live"
  HEALTH_READY_PATH: "/health/ready"
  HEALTH_STARTUP_PATH: "/health/startup"