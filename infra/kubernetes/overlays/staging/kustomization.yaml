apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: lomash-wood-staging

namePrefix: staging-

commonLabels:
  environment: staging
  app.kubernetes.io/managed-by: kustomize

commonAnnotations:
  deployment.lomashwood.co.uk/environment: staging
  deployment.lomashwood.co.uk/managed-by: kustomize

resources:
  - ../../base/namespace.yaml
  - ../../base/configmap.yaml
  - ../../base/secrets.yaml
  - ../../base/deployments/api-gateway.yaml
  - ../../base/deployments/auth-service.yaml
  - ../../base/deployments/product-service.yaml
  - ../../base/deployments/order-payment-service.yaml
  - ../../base/deployments/appointment-service.yaml
  - ../../base/deployments/content-service.yaml
  - ../../base/deployments/customer-service.yaml
  - ../../base/deployments/notification-service.yaml
  - ../../base/deployments/analytics-service.yaml
  - ../../base/services/api-gateway.yaml
  - ../../base/services/auth-service.yaml
  - ../../base/services/product-service.yaml
  - ../../base/services/order-payment-service.yaml
  - ../../base/services/appointment-service.yaml
  - ../../base/services/content-service.yaml
  - ../../base/services/customer-service.yaml
  - ../../base/services/notification-service.yaml
  - ../../base/services/analytics-service.yaml
  - ../../base/ingress/api-gateway-ingress.yaml
  - ../../base/ingress/internal-services-ingress.yaml
  - ../../base/autoscaling/api-gateway-hpa.yaml
  - ../../base/autoscaling/auth-service-hpa.yaml
  - ../../base/autoscaling/product-service-hpa.yaml
  - ../../base/autoscaling/order-payment-service-hpa.yaml
  - ../../base/autoscaling/appointment-service-hpa.yaml
  - ../../base/autoscaling/content-service-hpa.yaml
  - ../../base/autoscaling/customer-service-hpa.yaml
  - ../../base/autoscaling/notification-service-hpa.yaml
  - ../../base/autoscaling/analytics-service-hpa.yaml
  - ../../base/monitoring/servicemonitors.yaml
  - ../../base/monitoring/prometheus-rules.yaml
  - ../../base/monitoring/alertmanager.yaml

patches:
  - path: patches/api-gateway.yaml
    target:
      kind: Deployment
      name: api-gateway
  - path: patches/auth-service.yaml
    target:
      kind: Deployment
      name: auth-service
  - path: patches/product-service.yaml
    target:
      kind: Deployment
      name: product-service
  - path: patches/order-payment-service.yaml
    target:
      kind: Deployment
      name: order-payment-service
  - path: patches/appointment-service.yaml
    target:
      kind: Deployment
      name: appointment-service
  - path: patches/content-service.yaml
    target:
      kind: Deployment
      name: content-service
  - path: patches/customer-service.yaml
    target:
      kind: Deployment
      name: customer-service
  - path: patches/notification-service.yaml
    target:
      kind: Deployment
      name: notification-service
  - path: patches/analytics-service.yaml
    target:
      kind: Deployment
      name: analytics-service

configMapGenerator:
  - name: api-gateway-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - CORS_ORIGIN=https://staging.lomashwood.co.uk,https://staging-admin.lomashwood.co.uk
      - RATE_LIMIT_MAX_REQUESTS=300
      - RATE_LIMIT_WINDOW_MS=60000
      - AUTH_SERVICE_URL=http://staging-auth-service.lomash-wood-staging.svc.cluster.local:3001
      - PRODUCT_SERVICE_URL=http://staging-product-service.lomash-wood-staging.svc.cluster.local:3002
      - ORDER_PAYMENT_SERVICE_URL=http://staging-order-payment-service.lomash-wood-staging.svc.cluster.local:3003
      - APPOINTMENT_SERVICE_URL=http://staging-appointment-service.lomash-wood-staging.svc.cluster.local:3004
      - CONTENT_SERVICE_URL=http://staging-content-service.lomash-wood-staging.svc.cluster.local:3005
      - CUSTOMER_SERVICE_URL=http://staging-customer-service.lomash-wood-staging.svc.cluster.local:3006
      - NOTIFICATION_SERVICE_URL=http://staging-notification-service.lomash-wood-staging.svc.cluster.local:3007
      - ANALYTICS_SERVICE_URL=http://staging-analytics-service.lomash-wood-staging.svc.cluster.local:3008
  - name: auth-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - SESSION_COOKIE_SECURE=true
      - BCRYPT_SALT_ROUNDS=12
      - JWT_ACCESS_TOKEN_EXPIRES_IN=15m
      - JWT_REFRESH_TOKEN_EXPIRES_IN=7d
      - MAX_LOGIN_ATTEMPTS=5
      - LOCKOUT_DURATION_MINUTES=15
  - name: product-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - REDIS_CACHE_TTL_SECONDS=1800
      - REDIS_PRODUCT_LIST_TTL_SECONDS=180
      - REDIS_PRODUCT_DETAIL_TTL_SECONDS=300
  - name: order-payment-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - STRIPE_API_VERSION=2024-11-20.acacia
      - ORDER_EXPIRY_MINUTES=30
      - ABANDONED_CHECKOUT_EXPIRY_HOURS=24
  - name: appointment-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - SEND_REMINDER_JOB_INTERVAL_MINUTES=15
      - CLEANUP_EXPIRED_SLOTS_INTERVAL_HOURS=6
      - ADMIN_NOTIFICATION_EMAIL=appointments-staging@lomashwood.co.uk
      - KITCHEN_TEAM_EMAIL=kitchen-staging@lomashwood.co.uk
      - BEDROOM_TEAM_EMAIL=bedroom-staging@lomashwood.co.uk
  - name: content-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - CDN_BASE_URL=https://staging-cdn.lomashwood.co.uk
      - S3_BUCKET_NAME=lomash-wood-media-staging
      - SITEMAP_REBUILD_INTERVAL_HOURS=6
      - SCHEDULED_POST_CHECK_INTERVAL_MINUTES=5
  - name: customer-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - REVIEW_MODERATION_REQUIRED=true
      - INACTIVE_USER_ANONYMIZE_AFTER_DAYS=9999
  - name: notification-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - EMAIL_PROVIDER=ses
      - SMS_PROVIDER=twilio
      - PUSH_PROVIDER=firebase
      - EMAIL_FROM_ADDRESS=noreply-staging@lomashwood.co.uk
      - RETRY_MAX_ATTEMPTS=3
      - FAILED_MESSAGE_RETRY_INTERVAL_MINUTES=15
  - name: analytics-service-config
    behavior: merge
    literals:
      - NODE_ENV=staging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      - EVENT_RETENTION_DAYS=90
      - RAW_EVENT_PURGE_AFTER_DAYS=30
      - FUNNEL_RECOMPUTE_INTERVAL_HOURS=2
      - DASHBOARD_REBUILD_INTERVAL_MINUTES=30

images:
  - name: lomashwood/api-gateway
    newTag: staging
  - name: lomashwood/auth-service
    newTag: staging
  - name: lomashwood/product-service
    newTag: staging
  - name: lomashwood/order-payment-service
    newTag: staging
  - name: lomashwood/appointment-service
    newTag: staging
  - name: lomashwood/content-service
    newTag: staging
  - name: lomashwood/customer-service
    newTag: staging
  - name: lomashwood/notification-service
    newTag: staging
  - name: lomashwood/analytics-service
    newTag: staging