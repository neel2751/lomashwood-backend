apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: internal-services-ingress
  namespace: lomash-wood
  labels:
    app.kubernetes.io/name: internal-services-ingress
    app.kubernetes.io/part-of: lomash-wood-platform
    app.kubernetes.io/component: ingress-internal
  annotations:
    kubernetes.io/ingress.class: "nginx-internal"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Internal-Request: true";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
    nginx.ingress.kubernetes.io/auth-snippet: |
      if ($http_x_internal_service_api_key = '') {
        return 401;
      }
    nginx.ingress.kubernetes.io/limit-rps: "200"
    nginx.ingress.kubernetes.io/limit-rpm: "2000"
    cert-manager.io/cluster-issuer: "letsencrypt-production"
    cert-manager.io/acme-challenge-type: "http01"
spec:
  ingressClassName: nginx-internal
  tls:
    - hosts:
        - internal.lomashwood.local
        - auth-internal.lomashwood.local
        - product-internal.lomashwood.local
        - order-internal.lomashwood.local
        - appointment-internal.lomashwood.local
        - content-internal.lomashwood.local
        - customer-internal.lomashwood.local
        - notification-internal.lomashwood.local
        - analytics-internal.lomashwood.local
      secretName: internal-services-tls
  rules:
    - host: auth-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: auth-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: auth-service
                port:
                  name: http
    - host: product-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: product-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: product-service
                port:
                  name: http
    - host: order-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: order-payment-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: order-payment-service
                port:
                  name: http
    - host: appointment-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: appointment-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: appointment-service
                port:
                  name: http
    - host: content-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: content-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: content-service
                port:
                  name: http
    - host: customer-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: customer-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: customer-service
                port:
                  name: http
    - host: notification-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: notification-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: notification-service
                port:
                  name: http
    - host: analytics-internal.lomashwood.local
      http:
        paths:
          - path: /internal(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: analytics-service
                port:
                  name: http
          - path: /health
            pathType: Exact
            backend:
              service:
                name: analytics-service
                port:
                  name: http
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-service-communication
  namespace: lomash-wood
  labels:
    app.kubernetes.io/name: internal-network-policy
    app.kubernetes.io/part-of: lomash-wood-platform
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/part-of: lomash-wood-platform
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomash-wood
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: lomash-wood-platform
      ports:
        - protocol: TCP
          port: 3001
        - protocol: TCP
          port: 3002
        - protocol: TCP
          port: 3003
        - protocol: TCP
          port: 3004
        - protocol: TCP
          port: 3005
        - protocol: TCP
          port: 3006
        - protocol: TCP
          port: 3007
        - protocol: TCP
          port: 3008
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 3000
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: 9090
        - protocol: TCP
          port: 9091
        - protocol: TCP
          port: 9092
        - protocol: TCP
          port: 9093
        - protocol: TCP
          port: 9094
        - protocol: TCP
          port: 9095
        - protocol: TCP
          port: 9096
        - protocol: TCP
          port: 9097
        - protocol: TCP
          port: 9098
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: lomash-wood
        - podSelector:
            matchLabels:
              app.kubernetes.io/part-of: lomash-wood-platform
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 169.254.0.0/16
              - 10.0.0.0/8
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 587
        - protocol: TCP
          port: 465
    - to: []
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
        - protocol: UDP
          port: 53