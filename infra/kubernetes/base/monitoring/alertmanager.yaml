apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: lomash-wood-alertmanager-config
  namespace: lomash-wood
  labels:
    app.kubernetes.io/name: lomash-wood-alertmanager-config
    app.kubernetes.io/part-of: lomash-wood-platform
    release: prometheus
spec:
  route:
    groupBy:
      - alertname
      - service
      - namespace
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: default-receiver
    routes:
      - matchers:
          - name: severity
            value: critical
        receiver: critical-receiver
        groupWait: 10s
        groupInterval: 2m
        repeatInterval: 1h
        continue: true

      - matchers:
          - name: severity
            value: critical
          - name: team
            value: payments
        receiver: payments-critical-receiver
        groupWait: 10s
        groupInterval: 1m
        repeatInterval: 30m
        continue: false

      - matchers:
          - name: severity
            value: critical
          - name: team
            value: platform
        receiver: platform-critical-receiver
        groupWait: 10s
        groupInterval: 2m
        repeatInterval: 30m
        continue: false

      - matchers:
          - name: severity
            value: warning
          - name: team
            value: backend
        receiver: backend-warning-receiver
        groupWait: 60s
        groupInterval: 10m
        repeatInterval: 6h
        continue: false

      - matchers:
          - name: severity
            value: warning
          - name: team
            value: platform
        receiver: platform-warning-receiver
        groupWait: 60s
        groupInterval: 10m
        repeatInterval: 6h
        continue: false

      - matchers:
          - name: team
            value: security
        receiver: security-receiver
        groupWait: 10s
        groupInterval: 2m
        repeatInterval: 1h
        continue: false

  receivers:
    - name: default-receiver
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":bell:"
          title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] Lomash Wood Alert'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Severity:* {{ .Labels.severity }}
            *Service:* {{ .Labels.service }}
            *Namespace:* {{ .Labels.namespace }}
            {{ if .Annotations.runbook }}*Runbook:* {{ .Annotations.runbook }}{{ end }}
            {{ end }}
          sendResolved: true

    - name: critical-receiver
      pagerdutyConfigs:
        - routingKey:
            name: alertmanager-pagerduty-secret
            key: PAGERDUTY_ROUTING_KEY
          severity: critical
          description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          details:
            service: '{{ .CommonLabels.service }}'
            namespace: '{{ .CommonLabels.namespace }}'
            runbook: '{{ .CommonAnnotations.runbook }}'
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-critical"
          username: "Prometheus Alertmanager"
          iconEmoji: ":rotating_light:"
          title: ':rotating_light: CRITICAL: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Service:* {{ .Labels.service }}
            *Namespace:* {{ .Labels.namespace }}
            {{ if .Annotations.runbook }}*Runbook:* <{{ .Annotations.runbook }}|Click Here>{{ end }}
            {{ end }}
          sendResolved: true

    - name: payments-critical-receiver
      pagerdutyConfigs:
        - routingKey:
            name: alertmanager-pagerduty-secret
            key: PAGERDUTY_PAYMENTS_ROUTING_KEY
          severity: critical
          description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
          details:
            service: order-payment-service
            runbook: '{{ .CommonAnnotations.runbook }}'
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-payments-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":credit_card:"
          title: ':rotating_light: PAYMENT CRITICAL: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            {{ if .Annotations.runbook }}*Runbook:* <{{ .Annotations.runbook }}|Click Here>{{ end }}
            {{ end }}
          sendResolved: true
      emailConfigs:
        - to: "payments-oncall@lomashwood.co.uk"
          from: "alertmanager@lomashwood.co.uk"
          smarthost: "smtp.lomashwood.co.uk:587"
          authUsername: "alertmanager@lomashwood.co.uk"
          authPassword:
            name: alertmanager-smtp-secret
            key: SMTP_PASSWORD
          requireTLS: true
          headers:
            Subject: '[CRITICAL] Payment Alert: {{ .CommonAnnotations.summary }}'
          html: |
            <h2 style="color:red;">CRITICAL Payment Alert</h2>
            {{ range .Alerts }}
            <p><strong>Alert:</strong> {{ .Annotations.summary }}</p>
            <p><strong>Description:</strong> {{ .Annotations.description }}</p>
            {{ if .Annotations.runbook }}<p><strong>Runbook:</strong> <a href="{{ .Annotations.runbook }}">{{ .Annotations.runbook }}</a></p>{{ end }}
            {{ end }}
          sendResolved: true

    - name: platform-critical-receiver
      pagerdutyConfigs:
        - routingKey:
            name: alertmanager-pagerduty-secret
            key: PAGERDUTY_PLATFORM_ROUTING_KEY
          severity: critical
          description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-infra-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":fire:"
          title: ':fire: INFRA CRITICAL: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Pod:* {{ .Labels.pod }}
            {{ if .Annotations.runbook }}*Runbook:* <{{ .Annotations.runbook }}|Click Here>{{ end }}
            {{ end }}
          sendResolved: true

    - name: backend-warning-receiver
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-backend-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":warning:"
          title: ':warning: WARNING: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Service:* {{ .Labels.service }}
            {{ end }}
          sendResolved: true

    - name: platform-warning-receiver
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-infra-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":warning:"
          title: ':warning: INFRA WARNING: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            {{ end }}
          sendResolved: true

    - name: security-receiver
      pagerdutyConfigs:
        - routingKey:
            name: alertmanager-pagerduty-secret
            key: PAGERDUTY_SECURITY_ROUTING_KEY
          severity: warning
          description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
      slackConfigs:
        - apiURL:
            name: alertmanager-slack-secret
            key: SLACK_WEBHOOK_URL
          channel: "#lomash-wood-security-alerts"
          username: "Prometheus Alertmanager"
          iconEmoji: ":lock:"
          title: ':lock: SECURITY ALERT: {{ .CommonAnnotations.summary }}'
          text: |
            {{ range .Alerts }}
            *Alert:* {{ .Annotations.summary }}
            *Description:* {{ .Annotations.description }}
            *Service:* {{ .Labels.service }}
            {{ end }}
          sendResolved: true
      emailConfigs:
        - to: "security@lomashwood.co.uk"
          from: "alertmanager@lomashwood.co.uk"
          smarthost: "smtp.lomashwood.co.uk:587"
          authUsername: "alertmanager@lomashwood.co.uk"
          authPassword:
            name: alertmanager-smtp-secret
            key: SMTP_PASSWORD
          requireTLS: true
          headers:
            Subject: '[SECURITY] Alert: {{ .CommonAnnotations.summary }}'
          sendResolved: true

  inhibitRules:
    - sourceMatchers:
        - name: severity
          value: critical
      targetMatchers:
        - name: severity
          value: warning
      equal:
        - alertname
        - service
        - namespace

    - sourceMatchers:
        - name: alertname
          value: ServiceDown
      targetMatchers:
        - name: alertname
          value: HighErrorRate
      equal:
        - service
        - namespace

    - sourceMatchers:
        - name: alertname
          value: ServiceDown
      targetMatchers:
        - name: alertname
          value: HighP99Latency
      equal:
        - service
        - namespace

    - sourceMatchers:
        - name: alertname
          value: PostgresDown
      targetMatchers:
        - name: alertname
          value: PrismaPoolExhausted
      equal:
        - namespace