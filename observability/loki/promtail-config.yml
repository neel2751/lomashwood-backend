server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /var/log/promtail/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: lomash-wood
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

scrape_configs:
  - job_name: api-gateway
    static_configs:
      - targets:
          - localhost
        labels:
          job: api-gateway
          service: api-gateway
          environment: production
          __path__: /var/log/lomash/api-gateway/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            method: method
            path: path
            status_code: statusCode
            duration: duration
            user_id: userId
            ip: ip
            message: message
      - labels:
          level:
          method:
          status_code:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: auth-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth-service
          service: auth-service
          environment: production
          __path__: /var/log/lomash/auth-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            user_id: userId
            action: action
            message: message
      - labels:
          level:
          action:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: product-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: product-service
          service: product-service
          environment: production
          __path__: /var/log/lomash/product-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            product_id: productId
            category: category
            message: message
      - labels:
          level:
          category:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: order-payment-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: order-payment-service
          service: order-payment-service
          environment: production
          __path__: /var/log/lomash/order-payment-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            order_id: orderId
            payment_id: paymentId
            stripe_event: stripeEvent
            message: message
      - labels:
          level:
          stripe_event:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: appointment-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: appointment-service
          service: appointment-service
          environment: production
          __path__: /var/log/lomash/appointment-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            booking_id: bookingId
            appointment_type: appointmentType
            message: message
      - labels:
          level:
          appointment_type:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: content-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: content-service
          service: content-service
          environment: production
          __path__: /var/log/lomash/content-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            content_type: contentType
            message: message
      - labels:
          level:
          content_type:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: customer-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: customer-service
          service: customer-service
          environment: production
          __path__: /var/log/lomash/customer-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            customer_id: customerId
            message: message
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: notification-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: notification-service
          service: notification-service
          environment: production
          __path__: /var/log/lomash/notification-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            channel: channel
            notification_type: notificationType
            message: message
      - labels:
          level:
          channel:
          notification_type:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: analytics-service
    static_configs:
      - targets:
          - localhost
        labels:
          job: analytics-service
          service: analytics-service
          environment: production
          __path__: /var/log/lomash/analytics-service/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            request_id: requestId
            event_type: eventType
            message: message
      - labels:
          level:
          event_type:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values:
              - project=lomash-wood
    relabel_configs:
      - source_labels:
          - __meta_docker_container_name
        regex: /(.*)
        target_label: container
      - source_labels:
          - __meta_docker_container_label_service
        target_label: service
      - source_labels:
          - __meta_docker_container_label_environment
        target_label: environment
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            message: message
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      - output:
          source: message

  - job_name: system-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          service: system
          environment: production
          __path__: /var/log/syslog
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\S+ \S+) (?P<host>\S+) (?P<process>\S+): (?P<message>.*)'
      - labels:
          host:
          process:
      - timestamp:
          source: timestamp
          format: Jan _2 15:04:05
      - output:
          source: message