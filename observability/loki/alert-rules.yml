groups:
  - name: lomash-wood-error-alerts
    interval: 1m
    rules:
      - alert: HighErrorRateApiGateway
        expr: |
          sum(rate({service="api-gateway", level="error"}[5m])) > 10
        for: 2m
        labels:
          severity: critical
          service: api-gateway
          team: platform
        annotations:
          summary: High error rate on API Gateway
          description: API Gateway is producing more than 10 errors per second over the last 5 minutes.
          runbook: https://docs.lomashwood.internal/runbooks/high-latency.md

      - alert: HighErrorRateAuthService
        expr: |
          sum(rate({service="auth-service", level="error"}[5m])) > 5
        for: 2m
        labels:
          severity: critical
          service: auth-service
          team: platform
        annotations:
          summary: High error rate on Auth Service
          description: Auth Service is producing more than 5 errors per second.
          runbook: https://docs.lomashwood.internal/runbooks/auth-failure.md

      - alert: HighErrorRateOrderPaymentService
        expr: |
          sum(rate({service="order-payment-service", level="error"}[5m])) > 5
        for: 1m
        labels:
          severity: critical
          service: order-payment-service
          team: payments
        annotations:
          summary: High error rate on Order/Payment Service
          description: Order Payment Service is producing more than 5 errors per second.
          runbook: https://docs.lomashwood.internal/runbooks/payment-incident.md

      - alert: StripeWebhookFailures
        expr: |
          sum(rate({service="order-payment-service"} |= "stripe webhook" |= "error"[10m])) > 3
        for: 2m
        labels:
          severity: critical
          service: order-payment-service
          team: payments
        annotations:
          summary: Stripe webhook processing failures detected
          description: Multiple Stripe webhook failures detected in the last 10 minutes.
          runbook: https://docs.lomashwood.internal/runbooks/payment-incident.md

      - alert: AppointmentServiceErrors
        expr: |
          sum(rate({service="appointment-service", level="error"}[5m])) > 3
        for: 2m
        labels:
          severity: warning
          service: appointment-service
          team: backend
        annotations:
          summary: Appointment service error rate elevated
          description: Appointment service errors exceed threshold.

      - alert: NotificationServiceFailures
        expr: |
          sum(rate({service="notification-service"} |= "failed to send"[10m])) > 5
        for: 3m
        labels:
          severity: warning
          service: notification-service
          team: backend
        annotations:
          summary: Notification delivery failures detected
          description: Notification service is failing to deliver messages.

      - alert: CustomerServiceErrors
        expr: |
          sum(rate({service="customer-service", level="error"}[5m])) > 3
        for: 2m
        labels:
          severity: warning
          service: customer-service
          team: backend
        annotations:
          summary: Customer service error rate elevated
          description: Customer service errors exceed threshold.

  - name: lomash-wood-security-alerts
    interval: 1m
    rules:
      - alert: MultipleFailedLoginAttempts
        expr: |
          sum(rate({service="auth-service"} |= "invalid credentials"[5m])) by (instance) > 20
        for: 1m
        labels:
          severity: critical
          service: auth-service
          team: security
        annotations:
          summary: Multiple failed login attempts detected
          description: Possible brute force attack. More than 20 failed login attempts per minute.
          runbook: https://docs.lomashwood.internal/runbooks/auth-failure.md

      - alert: SuspiciousAuthActivity
        expr: |
          sum(rate({service="auth-service"} |= "unauthorized"[5m])) > 50
        for: 1m
        labels:
          severity: critical
          service: auth-service
          team: security
        annotations:
          summary: Suspicious authentication activity detected
          description: Unusually high number of unauthorized access attempts.

      - alert: RateLimitTriggered
        expr: |
          sum(rate({service="api-gateway"} |= "rate limit exceeded"[5m])) > 100
        for: 2m
        labels:
          severity: warning
          service: api-gateway
          team: platform
        annotations:
          summary: Rate limiting is being triggered frequently
          description: High volume of rate-limited requests on the API Gateway.

  - name: lomash-wood-database-alerts
    interval: 1m
    rules:
      - alert: PrismaConnectionErrors
        expr: |
          sum(rate({} |= "PrismaClientKnownRequestError"[5m])) > 10
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: High Prisma database connection errors
          description: Multiple Prisma database errors detected across services.
          runbook: https://docs.lomashwood.internal/runbooks/database-failure.md

      - alert: DatabaseQuerySlowness
        expr: |
          sum(rate({} |= "query took"[10m])) > 20
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: Slow database queries detected
          description: Multiple slow database queries are being logged.

  - name: lomash-wood-business-alerts
    interval: 5m
    rules:
      - alert: AppointmentBookingDropOff
        expr: |
          sum(rate({service="appointment-service"} |= "booking created"[1h])) < 0.1
        for: 30m
        labels:
          severity: warning
          service: appointment-service
          team: business
        annotations:
          summary: Low appointment booking rate
          description: Appointment bookings have dropped significantly in the past hour.

      - alert: BrochureRequestFailures
        expr: |
          sum(rate({service="customer-service"} |= "brochure request" |= "error"[15m])) > 2
        for: 5m
        labels:
          severity: warning
          service: customer-service
          team: backend
        annotations:
          summary: Brochure request submissions failing
          description: Multiple brochure request form submissions are failing.

      - alert: NewsletterSubscriptionErrors
        expr: |
          sum(rate({service="customer-service"} |= "newsletter" |= "error"[15m])) > 2
        for: 5m
        labels:
          severity: warning
          service: customer-service
          team: backend
        annotations:
          summary: Newsletter subscription errors detected
          description: Newsletter subscriptions are failing to process.

  - name: lomash-wood-infrastructure-alerts
    interval: 1m
    rules:
      - alert: ServiceDown
        expr: |
          sum by (service) (rate({level="error"} |= "ECONNREFUSED"[5m])) > 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: Service connection refused
          description: A downstream service is refusing connections. Possible service outage.
          runbook: https://docs.lomashwood.internal/runbooks/outage.md

      - alert: RedisConnectionFailure
        expr: |
          sum(rate({} |= "Redis connection"[5m]) |= "error") > 3
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: Redis connection failures detected
          description: Services are failing to connect to Redis cache.
          runbook: https://docs.lomashwood.internal/runbooks/outage.md

      - alert: S3UploadFailures
        expr: |
          sum(rate({service="content-service"} |= "S3" |= "error"[10m])) > 3
        for: 2m
        labels:
          severity: warning
          service: content-service
          team: platform
        annotations:
          summary: S3 upload failures detected
          description: Media uploads to S3 are failing in the content service.