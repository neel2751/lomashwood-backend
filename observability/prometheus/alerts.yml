global:
  resolve_timeout: 5m
  slack_api_url: "${SLACK_WEBHOOK_URL}"
  pagerduty_url: "https://events.pagerduty.com/v2/enqueue"

templates:
  - /etc/alertmanager/templates/*.tmpl

route:
  group_by:
    - alertname
    - cluster
    - service
    - severity
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: slack-warning

  routes:

    - match:
        severity: critical
      receiver: pagerduty-critical
      continue: true

    - match:
        severity: critical
      receiver: slack-critical
      continue: false

    - match:
        severity: warning
      receiver: slack-warning
      continue: false

    - match:
        team: security
      receiver: slack-security
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    - match:
        team: devops
      receiver: slack-devops
      continue: false

    - match_re:
        alertname: "^(ServiceDown|PaymentServiceDown|PostgresDown|RedisDown|BlackboxEndpointDown)$"
      receiver: pagerduty-critical
      group_wait: 0s
      repeat_interval: 30m
      continue: true

    - match:
        alertname: SLOBudgetBurnRateCritical
      receiver: pagerduty-critical
      group_wait: 0s
      repeat_interval: 1h
      continue: true

inhibit_rules:

  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal:
      - alertname
      - service

  - source_match:
      alertname: ServiceDown
    target_match_re:
      alertname: ".+"
    equal:
      - service

  - source_match:
      alertname: PostgresDown
    target_match_re:
      alertname: "^(PostgresHighConnections|PostgresSlowQueries|PostgresReplicationLag|PostgresDiskUsageHigh)$"
    equal:
      - instance

  - source_match:
      alertname: RedisDown
    target_match:
      alertname: RedisHighMemoryUsage

receivers:

  - name: pagerduty-critical
    pagerduty_configs:
      - routing_key: "${PAGERDUTY_INTEGRATION_KEY}"
        severity: critical
        description: "{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}"
        details:
          service: "{{ .GroupLabels.service }}"
          environment: "{{ .GroupLabels.environment }}"
          cluster: "{{ .GroupLabels.cluster }}"
          description: "{{ range .Alerts }}{{ .Annotations.description }}{{ end }}"
          runbook: "{{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}"
        links:
          - href: "{{ range .Alerts }}{{ .Annotations.runbook }}{{ end }}"
            text: "Runbook"
          - href: "https://grafana.lomashwood.com/d/api-gateway-dashboard"
            text: "Grafana Dashboard"
        client: "Lomash Wood Prometheus"
        client_url: "https://prometheus.lomashwood.com"

  - name: slack-critical
    slack_configs:
      - channel: "#incidents"
        send_resolved: true
        icon_emoji: ":red_circle:"
        username: "Prometheus Alert"
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }} :fire:{{ end }}] {{ .CommonLabels.alertname }}
        title_link: "https://grafana.lomashwood.com"
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Severity:* `{{ .Labels.severity }}`
          *Service:* `{{ .Labels.service }}`
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook }}
          *Started:* {{ .StartsAt | since }}
          {{ end }}
        color: |-
          {{ if eq .Status "firing" }}danger{{ else }}good{{ end }}
        actions:
          - type: button
            text: "View Dashboard"
            url: "https://grafana.lomashwood.com"
          - type: button
            text: "View Runbook"
            url: "{{ (index .Alerts 0).Annotations.runbook }}"
          - type: button
            text: "Acknowledge (PagerDuty)"
            url: "https://lomashwood.pagerduty.com"

  - name: slack-warning
    slack_configs:
      - channel: "#alerts"
        send_resolved: true
        icon_emoji: ":warning:"
        username: "Prometheus Alert"
        title: |-
          [{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Severity:* `{{ .Labels.severity }}`
          *Service:* `{{ .Labels.service }}`
          *Description:* {{ .Annotations.description }}
          {{ if .Annotations.runbook }}*Runbook:* {{ .Annotations.runbook }}{{ end }}
          {{ end }}
        color: |-
          {{ if eq .Status "firing" }}warning{{ else }}good{{ end }}

  - name: slack-security
    slack_configs:
      - channel: "#security-alerts"
        send_resolved: true
        icon_emoji: ":lock:"
        username: "Security Alert"
        title: |-
          :shield: [{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* `{{ .Labels.severity }}`
          {{ if .Annotations.runbook }}*Runbook:* {{ .Annotations.runbook }}{{ end }}
          {{ end }}
        color: danger

  - name: slack-devops
    slack_configs:
      - channel: "#devops-alerts"
        send_resolved: true
        icon_emoji: ":wrench:"
        username: "Infrastructure Alert"
        title: |-
          [{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}
        text: |-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Node/Instance:* `{{ .Labels.node }}{{ .Labels.instance }}`
          {{ end }}
        color: |-
          {{ if eq .Status "firing" }}warning{{ else }}good{{ end }}