groups:

  - name: lomash-wood.http
    interval: 15s
    rules:

      - alert: ServiceDown
        expr: up{job=~"api-gateway|auth-service|product-service|order-payment-service|appointment-service|content-service|customer-service|notification-service|analytics-service"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Service {{ $labels.service }} is down"
          description: "{{ $labels.service }} pod {{ $labels.pod }} has been unreachable for more than 1 minute."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/outage.md"

      - alert: HighErrorRate
        expr: |
          (
            sum by (service) (rate(http_requests_total{status=~"5..",job=~"api-gateway|auth-service|product-service|order-payment-service|appointment-service"}[5m]))
            /
            sum by (service) (rate(http_requests_total{job=~"api-gateway|auth-service|product-service|order-payment-service|appointment-service"}[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "{{ $labels.service }} error rate is {{ $value | humanizePercentage }} over the last 5 minutes (threshold: 1%)."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/outage.md"

      - alert: ElevatedErrorRate
        expr: |
          (
            sum by (service) (rate(http_requests_total{status=~"5..",job=~"api-gateway|auth-service|product-service|order-payment-service|appointment-service"}[5m]))
            /
            sum by (service) (rate(http_requests_total{job=~"api-gateway|auth-service|product-service|order-payment-service|appointment-service"}[5m]))
          ) > 0.005
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Elevated error rate on {{ $labels.service }}"
          description: "{{ $labels.service }} error rate is {{ $value | humanizePercentage }} over the last 5 minutes (threshold: 0.5%)."

      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95,
            sum by (service, le) (rate(http_request_duration_seconds_bucket{job=~"api-gateway|auth-service|product-service"}[5m]))
          ) > 0.8
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "High P95 latency on {{ $labels.service }}"
          description: "{{ $labels.service }} P95 latency is {{ $value | humanizeDuration }} (threshold: 800ms)."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/high-latency.md"

      - alert: CriticalP95Latency
        expr: |
          histogram_quantile(0.95,
            sum by (service, le) (rate(http_request_duration_seconds_bucket{job=~"api-gateway|auth-service|product-service"}[5m]))
          ) > 2.0
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Critical P95 latency on {{ $labels.service }}"
          description: "{{ $labels.service }} P95 latency is {{ $value | humanizeDuration }} (threshold: 2s). Immediate action required."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/high-latency.md"

      - alert: HighP95PaymentLatency
        expr: |
          histogram_quantile(0.95,
            sum by (service, le) (rate(http_request_duration_seconds_bucket{job="order-payment-service"}[5m]))
          ) > 1.5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "High P95 latency on order-payment-service"
          description: "Payment service P95 latency is {{ $value | humanizeDuration }} (threshold: 1.5s)."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/payment-incident.md"

      - alert: BlackboxEndpointDown
        expr: probe_success{job="blackbox-http"} == 0
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Endpoint {{ $labels.instance }} is unreachable"
          description: "Blackbox probe failed for {{ $labels.instance }} for more than 2 minutes."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/outage.md"

      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry{job="blackbox-http"} - time() < 86400 * 14
        for: 1h
        labels:
          severity: warning
          team: devops
        annotations:
          summary: "SSL certificate expiring soon for {{ $labels.instance }}"
          description: "SSL certificate for {{ $labels.instance }} expires in less than 14 days."

  - name: lomash-wood.auth
    interval: 15s
    rules:

      - alert: HighLoginFailureRate
        expr: |
          sum(rate(auth_login_failures_total[5m])) > 10
        for: 3m
        labels:
          severity: warning
          team: security
        annotations:
          summary: "High login failure rate detected"
          description: "Login failure rate is {{ $value | humanize }} per second over the last 5 minutes. Possible brute-force attack."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/auth-failure.md"

      - alert: AuthServiceHighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{service="auth-service",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{service="auth-service"}[5m]))
          ) > 0.02
        for: 3m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Auth service error rate is critical"
          description: "auth-service error rate is {{ $value | humanizePercentage }}. Users may be unable to log in."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/auth-failure.md"

      - alert: TokenBlacklistRedisUnreachable
        expr: redis_up{job="redis-exporter"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Redis is unreachable — token blacklist unavailable"
          description: "Redis has been unreachable for 1 minute. Session management and token blacklisting are degraded."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/auth-failure.md"

  - name: lomash-wood.payments
    interval: 10s
    rules:

      - alert: PaymentServiceDown
        expr: up{job="order-payment-service"} == 0
        for: 30s
        labels:
          severity: critical
          team: backend
          pagerduty: "true"
        annotations:
          summary: "order-payment-service is DOWN"
          description: "order-payment-service has been unreachable for 30 seconds. Payments are unavailable."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/payment-incident.md"

      - alert: HighPaymentFailureRate
        expr: |
          (
            sum(rate(payment_transactions_total{status="failed"}[10m]))
            /
            sum(rate(payment_transactions_total[10m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: backend
          pagerduty: "true"
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }} over the last 10 minutes (threshold: 5%)."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/payment-incident.md"

      - alert: WebhookProcessingBacklog
        expr: |
          webhook_queue_depth{service="order-payment-service"} > 50
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Stripe webhook processing backlog"
          description: "Webhook queue depth is {{ $value }} (threshold: 50). Events may be delayed."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/payment-incident.md"

      - alert: StuckPendingOrders
        expr: |
          count(
            order_age_seconds{status="PENDING_PAYMENT"} > 3600
          ) > 5
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Orders stuck in PENDING_PAYMENT state"
          description: "{{ $value }} orders have been in PENDING_PAYMENT for more than 1 hour. Possible webhook failure."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/payment-incident.md"

  - name: lomash-wood.database
    interval: 30s
    rules:

      - alert: PostgresDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          pagerduty: "true"
        annotations:
          summary: "PostgreSQL instance {{ $labels.instance }} is down"
          description: "PostgreSQL on {{ $labels.instance }} has been unreachable for 1 minute."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: PostgresHighConnections
        expr: |
          (pg_stat_database_numbackends / pg_settings_max_connections) > 0.80
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "PostgreSQL connection usage high on {{ $labels.instance }}"
          description: "Connection usage is {{ $value | humanizePercentage }} of max_connections on {{ $labels.instance }}."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: PostgresConnectionPoolExhausted
        expr: |
          (pg_stat_database_numbackends / pg_settings_max_connections) > 0.95
        for: 2m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "PostgreSQL connection pool nearly exhausted on {{ $labels.instance }}"
          description: "Connection usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}. New connections will be rejected."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: PostgresSlowQueries
        expr: |
          pg_stat_activity_max_tx_duration{state="active"} > 30
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Long-running PostgreSQL queries on {{ $labels.instance }}"
          description: "Queries running for more than 30 seconds detected on {{ $labels.instance }}."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: PostgresReplicationLag
        expr: |
          pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "PostgreSQL replication lag on {{ $labels.instance }}"
          description: "Replication lag is {{ $value | humanizeDuration }} on {{ $labels.instance }} (threshold: 30s)."

      - alert: PostgresDiskUsageHigh
        expr: |
          (pg_database_size_bytes / node_filesystem_size_bytes{mountpoint="/var/lib/postgresql"}) > 0.80
        for: 10m
        labels:
          severity: warning
          team: devops
        annotations:
          summary: "PostgreSQL disk usage high on {{ $labels.instance }}"
          description: "PostgreSQL disk usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Redis is down"
          description: "Redis has been unreachable for 1 minute. Session management and caching are unavailable."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/database-failure.md"

      - alert: RedisHighMemoryUsage
        expr: |
          (redis_memory_used_bytes / redis_memory_max_bytes) > 0.85
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Redis memory usage high"
          description: "Redis memory usage is {{ $value | humanizePercentage }} of maxmemory."

  - name: lomash-wood.infrastructure
    interval: 30s
    rules:

      - alert: NodeHighCPU
        expr: |
          (1 - avg by (node) (rate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.85
        for: 10m
        labels:
          severity: warning
          team: devops
        annotations:
          summary: "High CPU usage on node {{ $labels.node }}"
          description: "CPU usage on {{ $labels.node }} is {{ $value | humanizePercentage }} (threshold: 85%)."

      - alert: NodeHighMemory
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.90
        for: 5m
        labels:
          severity: critical
          team: devops
        annotations:
          summary: "High memory usage on node {{ $labels.node }}"
          description: "Memory usage on {{ $labels.node }} is {{ $value | humanizePercentage }} (threshold: 90%)."

      - alert: NodeDiskPressure
        expr: |
          (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"}) < 0.15
        for: 5m
        labels:
          severity: warning
          team: devops
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk {{ $labels.mountpoint }} on {{ $labels.instance }} has {{ $value | humanizePercentage }} free."

      - alert: PodCrashLooping
        expr: |
          rate(kube_pod_container_status_restarts_total{namespace="lomash-wood"}[15m]) * 60 * 15 > 3
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "Pod {{ $labels.pod }} is crash-looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has restarted more than 3 times in the last 15 minutes."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/outage.md"

      - alert: PodNotReady
        expr: |
          kube_pod_status_ready{namespace="lomash-wood", condition="true"} == 0
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Pod {{ $labels.pod }} is not ready"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has not been ready for 5 minutes."

      - alert: DeploymentReplicasMismatch
        expr: |
          kube_deployment_spec_replicas{namespace="lomash-wood"}
          != kube_deployment_status_replicas_available{namespace="lomash-wood"}
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Deployment {{ $labels.deployment }} has unavailable replicas"
          description: "Deployment {{ $labels.deployment }} expected {{ $value }} replicas but not all are available."

      - alert: HPAMaxReplicasReached
        expr: |
          kube_horizontalpodautoscaler_status_current_replicas{namespace="lomash-wood"}
          == kube_horizontalpodautoscaler_spec_max_replicas{namespace="lomash-wood"}
        for: 10m
        labels:
          severity: warning
          team: devops
        annotations:
          summary: "HPA {{ $labels.horizontalpodautoscaler }} has reached max replicas"
          description: "HPA for {{ $labels.horizontalpodautoscaler }} is at maximum replicas. Consider increasing limits."

  - name: lomash-wood.appointments
    interval: 30s
    rules:

      - alert: AppointmentServiceDown
        expr: up{job="appointment-service"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "appointment-service is down"
          description: "appointment-service has been unreachable for 1 minute. Customers cannot book consultations."
          runbook: "https://github.com/lomash-wood/backend/blob/main/docs/runbooks/outage.md"

      - alert: AppointmentBookingErrorRate
        expr: |
          (
            sum(rate(http_requests_total{service="appointment-service",status=~"5..",endpoint="/v1/appointments"}[5m]))
            /
            sum(rate(http_requests_total{service="appointment-service",endpoint="/v1/appointments"}[5m]))
          ) > 0.02
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "High error rate on appointment booking endpoint"
          description: "Appointment booking error rate is {{ $value | humanizePercentage }}."

  - name: lomash-wood.notifications
    interval: 60s
    rules:

      - alert: NotificationDeliveryFailureRate
        expr: |
          (
            sum(rate(notification_sent_total{status="failed"}[10m]))
            /
            sum(rate(notification_sent_total[10m]))
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "High notification delivery failure rate"
          description: "Notification delivery failure rate is {{ $value | humanizePercentage }} (threshold: 10%)."

      - alert: EmailDeliveryFailing
        expr: |
          sum(rate(email_sent_total{status="failed"}[10m])) > 5
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "Email delivery failures detected"
          description: "More than 5 email delivery failures per minute in the last 10 minutes."

  - name: lomash-wood.slo
    interval: 60s
    rules:

      - alert: SLOBudgetBurnRateCritical
        expr: |
          (
            sum(rate(http_requests_total{status=~"5..",job="api-gateway"}[1h]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[1h]))
          ) > 0.001 * 14.4
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: "SLO error budget burning too fast (1h window)"
          description: "Error budget is being consumed at 14.4× the allowed rate. Current error rate: {{ $value | humanizePercentage }}."

      - alert: SLOBudgetBurnRateWarning
        expr: |
          (
            sum(rate(http_requests_total{status=~"5..",job="api-gateway"}[6h]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[6h]))
          ) > 0.001 * 6
        for: 30m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "SLO error budget burn rate elevated (6h window)"
          description: "Error budget is being consumed at 6× the allowed rate over 6 hours."