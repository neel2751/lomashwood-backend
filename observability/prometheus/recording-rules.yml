groups:

  - name: lomash-wood.http.recording
    interval: 15s
    rules:

      - record: job:http_requests_total:rate5m
        expr: |
          sum by (job, service, status, method) (
            rate(http_requests_total[5m])
          )

      - record: job:http_requests_total:rate1h
        expr: |
          sum by (job, service, status, method) (
            rate(http_requests_total[1h])
          )

      - record: job:http_request_duration_seconds:p50_5m
        expr: |
          histogram_quantile(0.50,
            sum by (job, service, le) (
              rate(http_request_duration_seconds_bucket[5m])
            )
          )

      - record: job:http_request_duration_seconds:p95_5m
        expr: |
          histogram_quantile(0.95,
            sum by (job, service, le) (
              rate(http_request_duration_seconds_bucket[5m])
            )
          )

      - record: job:http_request_duration_seconds:p99_5m
        expr: |
          histogram_quantile(0.99,
            sum by (job, service, le) (
              rate(http_request_duration_seconds_bucket[5m])
            )
          )

      - record: job:http_request_duration_seconds:p95_1h
        expr: |
          histogram_quantile(0.95,
            sum by (job, service, le) (
              rate(http_request_duration_seconds_bucket[1h])
            )
          )

      - record: job:http_error_rate:rate5m
        expr: |
          sum by (service) (rate(http_requests_total{status=~"5.."}[5m]))
          /
          sum by (service) (rate(http_requests_total[5m]))

      - record: job:http_error_rate:rate1h
        expr: |
          sum by (service) (rate(http_requests_total{status=~"5.."}[1h]))
          /
          sum by (service) (rate(http_requests_total[1h]))

      - record: job:http_4xx_rate:rate5m
        expr: |
          sum by (service) (rate(http_requests_total{status=~"4.."}[5m]))
          /
          sum by (service) (rate(http_requests_total[5m]))

      - record: job:http_request_rate:rate5m
        expr: |
          sum by (service) (rate(http_requests_total[5m]))

      - record: job:http_request_rate:rate1h
        expr: |
          sum by (service) (rate(http_requests_total[1h]))

  - name: lomash-wood.auth.recording
    interval: 15s
    rules:

      - record: auth:login_attempts:rate5m
        expr: |
          sum(rate(auth_login_attempts_total[5m]))

      - record: auth:login_failures:rate5m
        expr: |
          sum(rate(auth_login_failures_total[5m]))

      - record: auth:login_failure_rate:rate5m
        expr: |
          sum(rate(auth_login_failures_total[5m]))
          /
          sum(rate(auth_login_attempts_total[5m]))

      - record: auth:registration_rate:rate5m
        expr: |
          sum(rate(auth_registrations_total[5m]))

      - record: auth:active_sessions:current
        expr: |
          auth_active_sessions_total

      - record: auth:token_refresh_rate:rate5m
        expr: |
          sum(rate(auth_token_refreshes_total[5m]))

  - name: lomash-wood.payments.recording
    interval: 10s
    rules:

      - record: payments:intent_creation_rate:rate5m
        expr: |
          sum(rate(payment_intent_created_total[5m]))

      - record: payments:success_rate:rate5m
        expr: |
          sum(rate(payment_transactions_total{status="succeeded"}[5m]))
          /
          sum(rate(payment_transactions_total[5m]))

      - record: payments:failure_rate:rate5m
        expr: |
          sum(rate(payment_transactions_total{status="failed"}[5m]))
          /
          sum(rate(payment_transactions_total[5m]))

      - record: payments:success_rate:rate1h
        expr: |
          sum(rate(payment_transactions_total{status="succeeded"}[1h]))
          /
          sum(rate(payment_transactions_total[1h]))

      - record: payments:volume_gbp:rate1h
        expr: |
          sum(rate(payment_amount_gbp_total{status="succeeded"}[1h]))

      - record: payments:refund_rate:rate1h
        expr: |
          sum(rate(refund_issued_total[1h]))
          /
          sum(rate(payment_transactions_total{status="succeeded"}[1h]))

      - record: payments:webhook_processing_p95:rate5m
        expr: |
          histogram_quantile(0.95,
            sum by (le) (rate(webhook_processing_duration_seconds_bucket[5m]))
          )

      - record: payments:pending_orders_age_max:current
        expr: |
          max(order_age_seconds{status="PENDING_PAYMENT"})

  - name: lomash-wood.appointments.recording
    interval: 30s
    rules:

      - record: appointments:bookings_rate:rate1h
        expr: |
          sum by (type) (rate(appointment_bookings_total[1h]))

      - record: appointments:cancellation_rate:rate1h
        expr: |
          sum(rate(appointment_cancellations_total[1h]))
          /
          sum(rate(appointment_bookings_total[1h]))

      - record: appointments:available_slots:current
        expr: |
          sum(appointment_slots_available_total)

      - record: appointments:booking_conversion_rate:rate1h
        expr: |
          sum(rate(appointment_bookings_total[1h]))
          /
          sum(rate(appointment_page_views_total[1h]))

  - name: lomash-wood.products.recording
    interval: 30s
    rules:

      - record: products:catalogue_size:current
        expr: |
          sum by (category) (products_total{status="active"})

      - record: products:page_view_rate:rate5m
        expr: |
          sum by (category) (rate(product_page_views_total[5m]))

      - record: products:search_rate:rate5m
        expr: |
          sum(rate(product_search_requests_total[5m]))

      - record: products:cache_hit_rate:rate5m
        expr: |
          sum(rate(product_cache_hits_total[5m]))
          /
          (sum(rate(product_cache_hits_total[5m])) + sum(rate(product_cache_misses_total[5m])))

  - name: lomash-wood.database.recording
    interval: 30s
    rules:

      - record: postgres:connection_utilisation:current
        expr: |
          sum by (instance) (pg_stat_database_numbackends)
          /
          sum by (instance) (pg_settings_max_connections)

      - record: postgres:transaction_rate:rate5m
        expr: |
          sum by (datname) (rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m]))

      - record: postgres:deadlock_rate:rate5m
        expr: |
          sum by (datname) (rate(pg_stat_database_deadlocks[5m]))

      - record: postgres:cache_hit_rate:rate5m
        expr: |
          sum by (datname) (rate(pg_stat_database_blks_hit[5m]))
          /
          (
            sum by (datname) (rate(pg_stat_database_blks_hit[5m]))
            + sum by (datname) (rate(pg_stat_database_blks_read[5m]))
          )

      - record: postgres:rows_fetched_rate:rate5m
        expr: |
          sum by (datname) (rate(pg_stat_database_tup_fetched[5m]))

      - record: redis:hit_rate:rate5m
        expr: |
          rate(redis_keyspace_hits_total[5m])
          /
          (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))

      - record: redis:memory_utilisation:current
        expr: |
          redis_memory_used_bytes / redis_memory_max_bytes

      - record: redis:ops_per_second:rate5m
        expr: |
          rate(redis_commands_processed_total[5m])

  - name: lomash-wood.infrastructure.recording
    interval: 30s
    rules:

      - record: node:cpu_utilisation:rate5m
        expr: |
          1 - avg by (node) (rate(node_cpu_seconds_total{mode="idle"}[5m]))

      - record: node:memory_utilisation:current
        expr: |
          1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)

      - record: node:disk_utilisation:current
        expr: |
          1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})

      - record: node:network_receive_bytes:rate5m
        expr: |
          sum by (node) (rate(node_network_receive_bytes_total[5m]))

      - record: node:network_transmit_bytes:rate5m
        expr: |
          sum by (node) (rate(node_network_transmit_bytes_total[5m]))

      - record: container:cpu_utilisation:rate5m
        expr: |
          sum by (pod, namespace, container) (
            rate(container_cpu_usage_seconds_total{container!=""}[5m])
          )

      - record: container:memory_utilisation:current
        expr: |
          sum by (pod, namespace, container) (
            container_memory_working_set_bytes{container!=""}
          )
          /
          sum by (pod, namespace, container) (
            container_spec_memory_limit_bytes{container!=""}
          )

  - name: lomash-wood.slo.recording
    interval: 60s
    rules:

      - record: slo:api_gateway:availability_rate:rate30d
        expr: |
          1 - (
            sum(rate(http_requests_total{job="api-gateway",status=~"5.."}[30d]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[30d]))
          )

      - record: slo:api_gateway:availability_rate:rate7d
        expr: |
          1 - (
            sum(rate(http_requests_total{job="api-gateway",status=~"5.."}[7d]))
            /
            sum(rate(http_requests_total{job="api-gateway"}[7d]))
          )

      - record: slo:payments:success_rate:rate30d
        expr: |
          sum(rate(payment_transactions_total{status="succeeded"}[30d]))
          /
          sum(rate(payment_transactions_total[30d]))

      - record: slo:error_budget_remaining:rate30d
        expr: |
          1 - (
            (1 - slo:api_gateway:availability_rate:rate30d)
            /
            (1 - 0.999)
          )

      - record: slo:auth_service:availability_rate:rate7d
        expr: |
          1 - (
            sum(rate(http_requests_total{job="auth-service",status=~"5.."}[7d]))
            /
            sum(rate(http_requests_total{job="auth-service"}[7d]))
          )

      - record: slo:appointment_service:availability_rate:rate7d
        expr: |
          1 - (
            sum(rate(http_requests_total{job="appointment-service",status=~"5.."}[7d]))
            /
            sum(rate(http_requests_total{job="appointment-service"}[7d]))
          )

  - name: lomash-wood.notifications.recording
    interval: 60s
    rules:

      - record: notifications:email_delivery_rate:rate1h
        expr: |
          sum(rate(email_sent_total{status="delivered"}[1h]))
          /
          sum(rate(email_sent_total[1h]))

      - record: notifications:sms_delivery_rate:rate1h
        expr: |
          sum(rate(sms_sent_total{status="delivered"}[1h]))
          /
          sum(rate(sms_sent_total[1h]))

      - record: notifications:send_rate:rate5m
        expr: |
          sum by (channel) (rate(notification_sent_total[5m]))

      - record: notifications:failure_rate:rate1h
        expr: |
          sum(rate(notification_sent_total{status="failed"}[1h]))
          /
          sum(rate(notification_sent_total[1h]))

  - name: lomash-wood.business.recording
    interval: 60s
    rules:

      - record: business:daily_revenue_gbp:rate24h
        expr: |
          sum(increase(payment_amount_gbp_total{status="succeeded"}[24h]))

      - record: business:orders_created:rate24h
        expr: |
          sum(increase(orders_created_total[24h]))

      - record: business:appointments_booked:rate24h
        expr: |
          sum by (type) (increase(appointment_bookings_total[24h]))

      - record: business:brochure_requests:rate24h
        expr: |
          sum(increase(brochure_requests_total[24h]))

      - record: business:newsletter_signups:rate24h
        expr: |
          sum(increase(newsletter_subscriptions_total[24h]))

      - record: business:new_user_registrations:rate24h
        expr: |
          sum(increase(auth_registrations_total[24h]))

      - record: business:average_order_value_gbp:rate24h
        expr: |
          sum(increase(payment_amount_gbp_total{status="succeeded"}[24h]))
          /
          sum(increase(orders_created_total[24h]))